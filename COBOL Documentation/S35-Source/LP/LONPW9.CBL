       IDENTIFICATION  DIVISION.
       PROGRAM-ID.       LONPW9.
       AUTHOR.              JTG.
       DATE-WRITTEN. 11/01/2002.
      *************************************************************************
      *  DESC:  LOAN PROCESSING
      *         BATCH PAYMENT REFERENCE CODES PROCESSING
      *
      *  ???LN-LBOX FLAG MUST BE "Y"
      *
      *  AN EXCEPTION REPORT (CONTAINING BOTH SUCCESSFULLY AND UNSUCCESSFULLY
      *  UPDATED ACCOUNTS) WILL BE PUT IN THE 'EO' DIRECTORY WITH THE BATCH
      *  NAME OF 'REF' (CORPORATE ALLOTMENT UPDATE)
      *
      *  NOTE: IN ORDER FOR THIS REPORT TO BE VIEWED USING BATCH REPORT
      *        VIEWER, A DUMMY BATCH MUST BE CREATED IN EOMAIN WITH
      *        THE NAME 'REF' AND CONTAINING NO STEPS.
      *
      *   THIS PROGRAM CALLS LONPFC, LONPFA, LONPFB AND LONPF2,
      *   TO POST THE PAYMENTS
      *  
      * "RV" REVERSALS WILL ONLY REVERSE IF THE LAST TRANSACTION ON THE
      *      ACCOUNT IS AN ACH BATCH PAYMENT. THIS PROGRAM HAS LONPF8 LOGIC
      *      COPIED IN IT INSTEAD OF CALLING LONPF8
      *
      *   AT END OF EACH BRANCHES UPDATE THE BP FILE WILL BE DELETED
      *   REGARDLESS OF WHETHER OR NOT UPDATES WERE SUCCESSFUL.
      *   AS PER JIM ROSENAUR, ALL EXCEPTIONS, FOR ANY REASON WILL
      *   BE POSTED MANUALLY FROM THE EXCEPTION REPORT.
      *
      *   PAYOFF NOTES.  LOOK FOR NOTES FOR PL 771 WHICH DEALT WITH
      *   FIXING ELECTRONIC PMT PAYOFFS, & ALSO DISALLOWED CERTAIN
      *   PAYOFF SITUATIONS INVOLVING O2/Z2.  IN TESTING, I FOUND
      *   THAT IF A PAYOFF INVOLVES A Z2, IT APPEARS TO PERFORM
      *   POST-REFUNDS-PL-PY, WHICH PAYS OFF THE ACCOUNT WITH A PA
      *   TRANSACTION INSTEAD OF A PO TRANSACTION.  I DON'T UNDERSTAND
      *   THIS.  I KNOW THERE IS THE COMPLICATION OF LEAVING A PENNY
      *   IN PRINCIPAL IF O2 IS NOT PAID OFF.  MY TEST THAT POSTED A
      *   Z2 & PAID OFF WITH A TRAN CODE OF "PA" WAS ELECTRONIC
      *   PROCESSING, SO THE AMT WAS THE EXACT PAYOFF.  BARB 5/17/12
      ******************************************************************
      * REV:
      * JTG 021011 ADDED NEW CODE FILE TYPE 'BR' - BATCH PAYMENT REFERENCE CODES
      *            **     ** COPIED FROM LONPW6.C                   REGACC #0006
      * JTG 021220 ADDED POFF-LCAP-BATCH-REFCD POFF-LCAP-BATCH-REFCD-LC-FG
      *            ADDED NEW CODE FILE TYPE 'BR'-BATCH PAYMENT REFERENCE CODES
      *            BATCH PAYMENT REVISIONS                        REGACC #0006
      * JTG 040331 ADDED LOGIC FOR POSTING BATCH PAYMENTS TO ACCOUNT'S
      *            WITH 'LN-OTBAL'                                 CENTRIX #2253
      * JTG 040720 CORRECTED ABOVE CENTRIX #2253 TO TEST CD-BR-OT-GL-ACCT
      *            FOR 2020 2020202 SPACES                         CENTRIX #2253
      * JTG 040827 ALLOW BATCH PAYMENTS TO ACCOUNTS WITH OTHER BALANCE BUT
      *            NOT APPLY APPLY MONIES TO OTHER BALANCE          REGACC #0070
      * BAH 050628 DONT TEST BR-BP-MAXCON, BR-BP-MAXREC, BR-LBOX-MAXCON
      *            OR BR-LBOX-MAXREC IF THEY ARE SET TO 999, SHOULDNT
      *            EXCLUDE ANYTHING IF SET TO 999, REGACC PL# 501
      * JTG 051109 ADDED NEW OPTION (BR-BP-PL = 'P') FOR CHARGE OFFS TO
      *            APPLY ALL MONIES TO PRINCIPAL (DEFERRING LATE CHARGES,
      *            INTEREST AND OTHER TO OWING) AND REJECTING PAYMENT AMOUNT
      *            IF GREATER THAN PAYOFF                           REGACC #0110
      * BLF 051116 IF BATCH IS SET UP AS "MULITPLE REFCD" TYPE (CD-BR-MULITPLE-
      *            REFCDS = "Y"), THE BATCH WHICH IS BEING PROCESSED WILL BE
      *            THE BATCH IN THE BP FILE PATHNAME (SAVED IN SAVE-BP-WK-REFCD)
      *            AND THE BATCH CODE SAVED IN THE BP-FILE (BP-REFCD) WILL BE
      *            PASSED TO LOAN PROCESSING IN BATCH-REFCD AND WILL BE USED
      *            FOR THE FLAGS AND GL ACCOUNTS.  REGACC PR# 107
      * BLF 051118 FIXED ROUTINE THAT CREATES SPOOL DIRECTORY TO CHECK
      *            FOR PRIOR RUNS IN THE DIRECTORY & INCREMENT STEP # SO
      *            PRIOR REPORTS ARE NOT WIPED OUT.  HAD TO CHANGE THE
      *            PATH OF THE SPOOL NAME FROM FULL TO RELATIVE BECAUSE FULL
      *            PATH WAS LONGER THAN ACCESS-BUF. THE OLD REPORT NAME WAS:
      *            /USR/DATA/R1/XXXX/EO/REFMMDDYY/0010BPREF AND EACH FILE
      *            RUN ON THE SAME DAY WOULD WIPE OUT THE PREVIOUS REPORT.
      *            NOW THE NEW REPORT NAMES WON'T WIPE OUT:
      *            /USR/DATA/R1/XXXX/EO/REFMMDDYY/0001BPREF
      *            /USR/DATA/R1/XXXX/EO/REFMMDDYY/0002BPREF, ETC.
      * BLF 051118 IF LN-SEQNO > 1 AND GP-I-AM-REGACC, FORCE 1 BACK TO
      *            LN-SEQNO & ALLOW TO CONTINUE INSTEAD OF WRITING AN
      *            EXCEPTION ERROR LINE & SKIPPING BATCH PAYMENT.  THEY
      *            GET MULTIPLE PAYMENTS & DON'T WANT REJECTED; I SAID
      *            I WOULD DO 2 MINUTE CHANGE & THEY CAN TEST - IF THIS
      *            SIMPLE CHANGE DOESN'T WORK WILL HAVE TO PUT IN
      *            PROGRAMMING REQUEST.
      * BLF 051121 AFTER UPDATE, RECONSTRUCT PATHNAME OF GLOBAL BTFILE & MOVE
      *            IT TO DONE DIRECTORY (ROUTINE = MOVE-BTFILE).  HERE IS THE
      *            PROBLEM:  COMPANY GETS GLOBAL FILE (BTFILE, NOW MAY BE
      *            ACHPMT, CCFILE, ETC), PUTS IN /USR/DATA/R1/ED & RUNS
      *            PROGRAM TO BREAK OUT INTO LOCAL BPFILES (FOR EXAMPLE,
      *            /USR/DATA/R1/XX0102/ED/B01021121123ACH1).  SINCE WE NOW HAVE
      *            IN MANY CASES A CORPORATE BRANCH RUNNING UPDATE FOR MANY
      *            LOCAL BRANCHES AND CORPORATE BRANCH MAY NOT HAVE ANY
      *            ACCOUNTS SO NO LOCAL BATCH PAYMENT FILE, WHEN THEY GO INTO
      *            "SET BATCH TO PROCESS", NO LOCAL BPFILES DISPLAY AS
      *            BATCHES TO SET, SO WE DISPLAY THE GLOBAL FILES.  BUT IT
      *            KEEPS DISPLAYING EVEN AFTER THE BATCH PAYMENT UPDATE IS DONE.
      *            SO WHEN UPDATE IS DONE, MOVE THE GLOBAL FILE & IT WON'T
      *            DISPLAY IN SET BATCH TO PROCESS.  FOR EXAMPLE:
      *            MV ../../ED/CCFIL1121123 ../../ED/DONE/CCFIL1121123
      *            CENTRIX, PL# 480
      * BLF 051128 CHANGE STEP COUNT TO START AT 100, SO BATCH STEPS WILL COME
      *            AFTER BPREF, WHICH IS ALSO STORED IN REF SPOOL DIRECTORY
      *            & STARTS WITH STEP 001
      *  CS 060110 IF BR-LBOX-PL 'P'(COLLECT PRINC ONLY & DEFER LC/INT) WE WERE
      *            ALLOWING APPLY TO PRIN > BALANCE CREATING NEGATIVE BALANCE
      * BLF 060314 ADDED BP-PAYDATE, LENDMARK PR# 2711, NOT SURE IF I WILL
      *            USE FOR ACH PAYMENTS, BUT SEEMS LIKE WE SHOULD HAVE ALWAYS
      *            HAD THIS SINCE MOST INPUT (BTFILES) CONTAIN THE REAL
      *            PAYMENT DATE; WILL CHECK HERE, IF 0 OR 202020 OR 020202
      *            WILL FORCE TRANS-DATE TO BP-PAYDATE, SO SHOULD ONLY MAKE
      *            A DIFFERENCE IF INPUT PROGRAM SUCH AS BPBKBR MOVES
      *            PAYMENT DATE TO BP.
      * BLF 060324 MOVED GPENV TO BEFORE INITIALIZATION.  I JUST ADDED
      *            CHECKING A GP ACH FLAG IN INIT, BUT IT HAS BEEN CHECKING
      *            GP-REFCD-NEXT-BATCH-START FOR A WHILE, NOT SURE WHY IT
      *            WORKED???  LENDMARK, PR# 2711
      * BLF 070301 IF BATCH HAS CD-BR-PAYOFF-FG = "Y", OVERRIDE BRANCH
      *            BATCH FLAGS TO ALLOW PAYOFF & PAYOFFS TO ACCTS WITH OTHER
      *            BALS:  BR-BP-ALLOW-PMT-ACCT-OTHBAL (+ LBOX) MUST BE "N",
      *            BR-BP-PAYOFF-NONCASH (+ LBOX) MUST BE "Y".  DON'T ASK ME
      *            WHY THE OTHER BAL FLAG MUST BE "N" - THIS SEEMS LIKE THE
      *            OPPOSITE OF WHAT YOU WOULD EXPECT, BUT OH WELL....
      *            REGACC PR# 160
      * BLF 070412 BARB & CINDY, ADD LOGIC TO POST "SS" THROUGH BATCH,
      *            QUOTING REGACC PR# 168
      * BLF 070412 BARB & CINDY, TWEAKED LOGIC WHICH CHECKS THE
      *            BP-ALLOW-PMT-ACCT-OTHBAL TO ONLY CHECK PAYOFF AMT IF THERE
      *            IS AN OTHER BAL ON LOAN
      * BLF 070412 BARB & CINDY, CLEAR HOLD-OVPAID-CHECK IN INITIALIZATION;
      *            MAIN EXCEPTION WAS NOT ADDING IF AMT IN HOLD-OVPAID-CHECK &
      *            IT COULD HAVE HUGE UNINITIALIZED AMT IN IT, SO EXCEPTION
      *            TOTALS COULD BE COMPLETELY JUNK, UNITED
      *  CS 070501 GENERATE AN EXCEPTION POSTING FOR AN IB LOAN IF INTEREST
      *            PAID THRU IS GREATER THAN THE POSTING DATE [BP-PAYDATE]
      *                                                       REGACC PR#168
      * BLF 070522 IF REGIONAL, USE 05 FOR PAYOFF CODE, REGACC PR# 160
      * BLM 080424 FIX CHECKS ON BRANCH OPTIONS FOR ODDPAY, NOPRIN, JUDGMENTS,
      *            AND FLASH - WAS CHECKING LBOX OPTIONS FOR ALLOTMENTS
      * BLM 080425 IF GP-I-AM-WORLD, ALLOW DUPLICATE PAYMENTS FOR A
      *            BORROWER LIKE FOR REGACC: IF LN-SEQNO > 1 FORCE 1 BACK TO
      *            LN-SEQNO & ALLOW TO CONTINUE INSTEAD OF WRITING EXCEPTION
      *            ERROR LINE & SKIPPING BATCH PAYMENT. WORLD PR# 573
      * BLM 080606 CHANGE REPORT.  HAD NOT BEEN PRINTING DETAIL LINE FOR
      *            A LONG TIME (MERC PR#244).  CHANGED TO PRINT 2 REPORTS IN
      *            REFMMDDYY SPOOL DIRECTORY.  THE SUMMARY REPORT (0100REFCD)
      *            IS A 1 LINE PER BRANCH SUMMARY WITH TOTALS FOR READ,
      *            WRITTEN, EXCEPTIONS & OVERPAYMENTS, NO PAGE ON BRANCH.
      *            THE EXCEPTION REPORT, 0100EXCEPT, PRINTS THE DETAIL
      *            INCLUDING BR#, ACCT #, AMT, DATE, REFCD, & ERROR
      *            DESCRIPTION FOR EACH BP WITH ERRORS SUCH AS INVALID ACCT OR
      *            PMT AMT EXCEEDING BALANCE.  BRANCHES WITH ERRORS WILL GET
      *            A TOTAL OF ERRORS & ERROR AMT.  KEVIN M AGREED THAT
      *            EXISTING CUSTOMERS USING THIS UPDATE WOULD NOT CARE THAT
      *            WE CHANGED REPORT, IT WAS MANY PAGES WITH MOST BRANCHES
      *            JUST GETTING TOTALS & A FEW ERRORS LINES.  WORLD PR# 573
      * BLM 080711 FIX TO NOT ALLOW PMT TO P&L INACTIVE ACCT (LN-PLCD = "I"),
      *            PMT WILL REJECT & PRINT ON EXCEPTION REPORT & WILL HAVE
      *            TO BE POSTED MANUALLY BY REVERSING PI, UNITED PL# 632
      * BLM 080711 CLEAR POSTING-ERRCD, HOLD-OVPAID-CHECK, & D-EXCEPT RIGHT
      *            AFTER READ OF BP; MAIN-EXCEPTION NOT ADDING TO EXCEPTIONS
      *            UNLESS HOLD-OVPAID-CHECK IS 0 & POSTING ERRCD NOT "O", SO
      *            AN ERROR IMMEDIATE FOLLOWING AN OVERPAY WAS NOT ADDED
      *            INTO BRANCH TOTALS, WORLD PR# 573
      * BLM 080714 BP-PAYOFF-NONCASH DOESN'T ALLOW BATCH PAYOFF IF OTHER
      *            CHARGES ON ACCT, OR PAYMENT EXCEEDS PAYOFF, OR PAYOFF
      *            PRIOR TO MATURITY.  I DON'T GET WHY THIS FLAG IS CALL
      *            GP-PAYOFF-NONCASH.  ANYWAY, WORLD ACCTS WILL BE PAID
      *            OFF EARLY WITH INSURANCE CLAIM PMTS, SO ALLOW EARLY
      *            PAYOFF IF BATCH PMT = PAYOFF.  ALSO SKIPPED THE CHECK
      *            ON NEGATIVE PURBAL WHICH ALSO INVOLVES GP-PAYOFF-
      *            NONCASH, SKIPPED IF I-AM-WORLD.  WORLD PR# 573.
      * BLM 080714 FIX EXCEPTION REPORT TO PRINT BRANCH & GRAND TOTALS FOR
      *            OVERPAYMENTS AS WELL AS EXCEPTIONS
      * BLM 080714 PUT A ZERO BAL CHECK BEFORE PAYOFF ROUTINES, THAT WAY
      *            YOU CAN DISTINGUISH BETWEEN PAID OUTS & LOANS WITH A
      *            BALANCE TOO LOW FOR BATCH PMT, WORLD PR# 573
      * BLM 080714 FIX PRINT OF OVERPAYMENTS ON SUMMARY REPORT, IT WAS MOVING
      *            THE COUNT TO THE AMT & VICE VERSA
      * BLM 080805 ADD TO TOTAL-READ & AMOUNT-READ IN BRANCH-EXCEPTION ROUTINE,
      *            WORLD PR# 573
      *  CS 081016 ADDED CHECKS FOR POSTING 'DF' THRU BATCH, IN MANUAL POSTING
      *            TESTS ARE DONE IN LONPF1 REGACC, ALLOW ZERO 'DF' IF THE
      *            BP-ALLOW-ZERO-DF = 'Y', ALSO TEST NEW FLAG BP-IGNORE-DEFPOL
      *            WHICH IGNORES MAX # OF DF IF SET TO 'Y' PR#219 REGACC
      * BLM 090403 ADD REFNO TO REPORT HEADINGS, REGACC
      *  CS 090428 MOVED TEST ON HOLD-CD-BR-POST-SS-TRCD FROM BPREF TO HERE.
      *  CS 090428 ADD OPTION TO CD-BR-POST-SS-TRCD OF 'R' WHICH WILL REJECT
      *            IF ACCOUNT IN REPO-ON-HAND-STATUS PR#244 REGACC
      * BLM 090507 IF I-AM-REGMGM, ALLOW MORE THAN 1 BATCH PMT PER ACCOUNT,
      *            SKIP EARLY PAYOFF CHECK, SKIP PURBAL CHECK, REGIONAL
      *            ASSURANCE BATCH INSURANCE CLAIMS, REGMGM PR#3359
      * CLS 090605 ADD SEPARATE REPO EXCEPTION. IF THIS EXISTS, IT APPENDS
      *            REPO REJECTS TO BATCH ID REPOEX. REPOS WILL ALSO APPEAR
      *            ON THE EXCEPTION REPORT REGACC PR#246
      *  CS 090715 MOVED TEST ON LN-INTPDTH-DATE > POSTING DATE BECAUSE IBPC-TEST
      *            NEEDS THE SPR & IT HASNT BEEN READ YET... CINDY
      *  CS 090717 CHANGED GET-SPR TO READ THE SPR ALWAYS. WHEN THE EXTENDED
      *            LATE CHARGE FILE IS USED IT REPLACES THE ORIG SP-LC-FIELDS
      *            & THE SPR DOESNT GET READ UNTIL THE KEY CHANGES.  IT WAS
      *            ASSESSING THE WRONG AMOUNTS. MIDATL PR#659
      * BLM 100305 DON'T PROCESS IF ACCOUNT HAS ESCROW, REGWAN PR# 3506
      * BLM 100312 IF I-AM-AUTOMOTIVE-CREDIT, ALLOW MORE THAN 1 BATCH PMT
      *            PER ACCOUNT, AUTOCR PR# 3560
      * BLM 111005 REPORT WAS PRINTING CLAIM # IF I-AM-WORLD.  CHANGED TO
      *            ONLY PRINT CLAIM# IF I-AM-WORLD & USER BRANCH DOES NOT
      *            START WITH 3 (MEXICO BATCH PMTS).  WORLD PR# 770
      * BLM 120118 UPDATE WAS SKIPPING DUPLICATE PAYMENTS ON ACCOUNTS EXCEPT
      *            FOR CERTAIN CUSTOMERS.  CHANGED TO DEFAULT TO ALLOWING
      *            DUPLICATE PAYMENTS ON SAME ACCOUNT.  SUPPORT PR# 3950
      * BLM 120224 IF I-AM-SOAUTO,  SKIP PURBAL CHECK, SOAUTO PR# 3980
      * BLM 120504 FIX SEVERAL PROBLEMS.  FIRST, BATCH PMTS FROM ELECTRONIC
      *            PMT EXTRACTION, IN THE CASE OF PAYOFFS, WOULD ONLY SEND
      *            PAYOFF AMT TO BANK, BUT WERE GENERATING OVERPAID AMTS
      *            AND "OV" TRANSACTIONS.  FIRST, ADDED A FLAG TO BP TO
      *            CLEARLY DESIGNATE PAYMENT AS COMING FROM ELECTRONIC PMT
      *            EXTRACTION (BP-CREATE-ACH-FG = "Y").  FIXED TO MOVE
      *            PAYOFF AMT TO BP-TRAMT FOR THESE ACCOUNTS BEFORE COMPUTING
      *            OVERPAY.  ALSO, FIXED Z2 TRANSACTION FOR THESE ACCOUNTS,
      *            WAS SENDING ENTIRE BP-TRAMT TO BANK INSTEAD OF JUST Z2 AMT.
      *            LAST, FIXED A BUG FOR ACCTS WITH O2.  IF AMT NOT QUITE
      *            ENOUGH TO PAY OFF ACCT, COULD GENERATE REBATES WITHOUT
      *            PAYING OFF ACCT.  FIXED TO REJECT O2 ACCTS IN THESE
      *            SITUATIONS (SEE NOTE IN CODE, MARKED 5/4/12).
      *            CITIZENS, PL# 771
      *  121026 CS ADD IF GP-I-AM-REGMGM AND A "PO", IF BATCH-REFCD = "ZIUI" OR
      *            "AUTO" OR "NONF" OR "PROP", SET HOLD-POCD TO "13",
      *            REGMGM  PR#3135
      * BLM 130212 IF HOLD-BP-ALLOW-PMT-ACCT-OTHBAL = "2" (OR HOLD-LBOX-ALLOW
      *            PMT-ACCT-OTHBAL = "2"), REJECT ACCTS WITH OTHER 2 BALANCE,
      *            SOAUTO PR# 4145
      *  CS 130918 SET HOLD-TDR2-ERR TO 0 AT READ OF NEXT BP.  'PA' ACCOUNTS
      *            WERE COMING THRU BATCH AND BECAUSE HOLD-TDR2-ERR WAS NOT ZERO
      *            WHEN IT GOT TO LONPF2, PA ACCOUNTS WERE WRITING THE TDR LOG
      *                                                  REGACC PR#815
      *  CS 140527 REPLACED MKDIR-CMD WITH C$MAKEDIR
      *  BAH 140926 MOVE "F" TO FULL-DISPLAY INSTEAD OF "P", AUTOMOTIVE PL#860
      *  BLM 141105 GET RID OF CHDIR & SET EXT-FILPATH INSTEAD.  DO SET 
      *             ENVIRONMENT ON FIL & POSTNAME & SET BRANCH.  RESTORE ALL
      *             UPON EXIT.
      *
      * KEC 2015.1120 {PD#00003} PARADATA <A30> [JAY CISZEWSKI]
      *         FIXED RC-TRANS-DATE FROM YYYMMDD TO CCYYMMDD.
      *  BAH 160125 SPLIT OUT LTFILE, PD0003
      *   CS 160222 REMOVE COPY LPWKLXE, ITS AN EARNINGS COPY MEMBER THAT IS
      *             PASSED IN LOAN PROCESSING VIA LP01WK USING WK-LX2-REC. 
      *             REPLACED WK-LX2-REC WITH WK-LXE-REC IN LP01WK 
      *             MOVED LPWKLXE TO LPWKLXE.NO
      *             SAVED VERSION LONPW9.160222
      *   CS 160303 ADDED TEST FOR ERRCD = "P" TO WICH IS SET IN LONPFC BATCH
      *            PAYMENT-ROUTINE WHEN PAID AHEAD IS NOT <
      *            SP-ALT-PREPAY-MONTHS.  WORLD PR#1140 
      *  BLM 160429 ADD LOGIC TO POST BK OR BD.  CD-BR-FILE-TYPE WILL BE "B",
      *             WILL NOT CALL LONPW9, JUST INITIALIZE LP-REC & BUFFERS
      *             HERE & CALL LONPF2, WORLD PR# 1151
      *  BLM 160621 IF BT-TRCD IS "RE", CALL LONPF7 INSTEAD OF LONPFC,
      *             REGACC PR# 382
      *  BLM 160802 ALLOW NEGATIVE AMT, SIGN IN 1ST BYTE OF BT-AMT, NOT
      *             ALLOWED UNLESS BT-ALLOW-NEGATIVE = Y, REGACC PR# 382
      *  BLM 161024 INITIALIZE BP-SEQNO TO 0 BEFORE STARTS
      *  BLM 161024 INITIALIZE HOLD-NFE-CK-NUMBER HOLD-PRIOR-DF-POSTDATE,
      *             WERE COMP-6, NOW COMP. PF2 CHECKING FOR 2020, SO
      *             WRITING NF & MEMO FOR BATCH PMTS, LEAVING 2020 IN
      *             TR-PRIOR-DF-POSTDATE
      *
      * KEC 2016.1128 {PR#00000} PARADATA <A30> [JAY CISZEWSKI]
      *          CHANGED EW-TRANS-DATE TO BE ACTIVE CCYYMMDD.
      *
      *   CS 170213 IF BT-TRCD IS "O2", CALL LONPF7 INSTEAD OF LONPFC
      *                                             PR#5239 SOAUTO
      *   CS 170626 ALLOWED "RP" BP-TRCD TO RUN FROM BATCH PR#1253
      *             NEEDED FOR INDIANA REFUND FIX CALL LONPFB FOR 'RP'
      *  BAH 170703 ACTIVATE 8 DIGIT DATES, PD0006
      *   CS 170705 ALLOWED BALANCE TO GO NEGATIVE WHEN POSTING 'SS' AND 
      *             GP-DONT-COLL-INT-ON-SS = 'Y' WHEN YOU ARE PROCESSING THRU
      *             BATCH PAYMENTS.  THERE IS A DIFFERENCE BTW BATCH AND PMT
      *             POSTING, NORMAL PMT POST ATTEMTS TO COLLECT OTHER WHEN 
      *             POSTING 'SS' BATCH HAS NOT TRIED TO COLLECT OTHER OWING 
      *             AND I DIDNT CHANGE THAT. I ADDED A TEST TO STOP NEGATIVE
      *             LN-CURBAL THAT SHOULD KICK OUT AS EXCEPTION.
      *             OF GP-DONT-COLL-INT-ON-SS = "Y" IF BP-TRAMT > LN-CURBAL -
      *             - .01 GENERATE EXCEPTION  PL#974 REGACC             
      *   CS 170712 CHANGED TEST ON GP-DONT-COLL-INT-ON-SS = "Y" TO ALSO TEST
      *             BP-TRCD = "SS", REGACC PL974A
      *  BLM 170629 CHANGES NEEDED FOR INDIANA REFUND FIX.  AFTER CALLING
      *             PAYMENT PROGRAM, WAS CHECKING FOR ERRCD OF P & GIVING
      *             ALT PREPAY ERROR. IT SEEMS LIKE ERRCD OF P IS GETTING
      *             RETURNED BY LONPFB , SO CHECK WHICH PAYMENT-PROG IS 
      *             CALLED WHEN CHECKING ERRCD.  WORLD PR# 1253
      *
      * KEC 2017.0912 {PR#01246} WORLD <A30> [JAY CISZEWSKI]
      *          WHEN ADDING THIS PR# TO A30, I NOTICED THAT A COPY
      *          MEMBER WAS NOT PROPERLY SETUP.  TO FIX IT I DID:
      *          - COPIED LIBLP/LPBP.CPY TO ../SV/LPBP.NO
      *          - MOVED  LIBLP/LPBP.CPY TO LIBLP/LPBP_CMD.CPY
      *          - EDITED LIBLP/LPBP_CMD.CPY TO LOWERCASE WHEN NEEDED
      *
      * BAH 171129 FIXED WK-LXE-REC
      * BAH 181211 GLOBAL LNFILE
      * BAH 190121 GLOBAL LXFILE
      * BAH 20190701 REMOVED U-INSOURS,AVAILABLE-CREDIT FROM LPPFBUF
      * BAH 20190723 CLEAR LXG-FUTURE FIELDS
      * BAH 20190723 CLEAR-EW-FILE FIELDS FOR FUTURE FIELDS!
      * BAH 20190924 REMOVED ACCESS-CALL LNFILE
      *  CS 20201008 ADD TEST ON BP-FROZEN-OVERRRIDE = "Y" WHICH WILL ALLOW
      *              BATCH PAYMENT WHEN LN-ACCT-FROZEN = "Y" PR# 1465
      * BAH 20210202 DO NOT ALLOW CD-BR-FILE-TYPE = "C", UMC DEBIT CARD PR#1490
      * BAH 20211015 CLEAR HOLD-PRIOR-DF-POSTDATE
      *              WRITE ERROR TRPFILE LONPF2, STATE 22007
      *              CONVERSION FAILED WHEN CONVERTING DATE 
      *  CS 20210324 ALLOW BATCH POSTING OF "PL", "P2, AND "P3.
      *              IF (BR-AUTO-PL-REF-AC = "Y" OR "2" OR "3") AND BP-TRCD
      *              IS ONE OF THESE, IT WILL BE REJECTED.
      *              IF ALREADY IN PL STATUS, REJECT, IF CONTRACTUAL OR
      *              RECENCY < 30, REJECT    PR#1548
      * BLM 220707   IF BP-TRCD = "RV", PERFORM VALIDATE-REVERSAL AND
      *              REVERSAL-POSTING, WORLD PR# 1557
      * BAH 20220818 REMOVED GLOBRD, READ GB-FILE INSTEAD
      * BAH 220912 NEEDED TO COMPUTE PAID THRU FOR LP-PDTH AND LP-CURBAL #1557
      * BAH 220921 ONLY PRINT LAST 4 OF SSNO #1557
      * BAH 2023.0328 ADDED SP-LCFRMLA "T" FOR "WI" UCCC LATE CHARGE #1597
      * BAH 2023.0607 MOVE 0 TO LP-TILLNO FOR BATCH PAYMENT REVERSALS, #1613
      * BAH 2023.1011 REMOVED USE OF BP-CREATE-ACH-FG, EPFILE, EWFILE
      * BAH 2024.0229 REMOVED THE "-" IN THE ACCTNO DETAIL LINE
      * BAH 2024.0410 REMOVED HOLD-TDR2-ERR FROM UPDATE-BUF
      * BAH 2025.0228 LXE-EARN(4) - (7) WERE NOT GETTING CLEARED LIKE
      *               LONPF1 DOES! S35Q-168
      * BAH 2025.0325 WK-FILE WAS NOT GETTING REMOVED AT END-PROGRAM S35Q-173
      ******************************************************************
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SOURCE-COMPUTER. 3B.
       OBJECT-COMPUTER. 3B.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
       COPY "LIBLP/LPFSWK.CPY".
       COPY "LIBLP/LPFSBP.CPY".
       COPY "LIBGB/GBFSPR.CPY".
       COPY "LIBLP/LPFSOP.CPY".
       I-O-CONTROL.
       DATA DIVISION.
       FILE SECTION.
       COPY "LIBLP/LPFDWK.CPY".
       COPY "LIBLP/LPFDBP.CPY".
       COPY "LIBGB/GBFDPR.CPY".
       COPY "LIBLP/LPFDOP.CPY".

       WORKING-STORAGE SECTION.
       77  SCCS-IDENTIFIER PIC X(37) VALUE
           "@(#)LP/LONPW9 S35 02/28/25-10:20:06 >".
      **************************************************
      *     P R O G R A M   W O R K E R S              *
      **************************************************
       COPY "LIBGB/GB01BR.CPY".
       COPY "LIBGB/GB01BR_SQL.CPY".
       COPY "LIBGB/GBWSBR.CPY".
       COPY "LIBGB/GB01GB.CPY".
       COPY "LIBGB/GB01GB_SQL.CPY".
       COPY "LIBGB/GBWSGB.CPY".
       COPY "LIBLP/LP01SP.CPY".
       COPY "LIBLP/LP01SPA.CPY".
       COPY "LIBLP/LP01SPB.CPY".
       COPY "LIBLP/LP01SPC.CPY".
       COPY "LIBLP/LP01SP_SQL.CPY".
       COPY "LIBLP/LPWSSP.CPY".
       COPY "LIBLP/LP01BW.CPY".
       COPY "LIBLP/LP01BW_SQL.CPY".
       COPY "LIBLP/LPWSBW.CPY".
       COPY "LIBLP/LP01LP.CPY".
       COPY "LIBLP/LP01LP_SQL.CPY".
       COPY "LIBLP/LPWSLP.CPY".
       COPY "LIBLP/LP01LX.CPY".
       COPY "LIBLP/LP01LX_SQL.CPY".
       COPY "LIBLP/LPWSLX.CPY".
       COPY "LIBLP/LP01LXE.CPY".
       COPY "LIBLP/LP01LXE_SQL.CPY".
       COPY "LIBLP/LPWSLXE.CPY".
       COPY "LIBLP/LP01LXG.CPY".
       COPY "LIBLP/LP01LXG_SQL.CPY".
       COPY "LIBLP/LPWSLXG.CPY".
       COPY "LIBLP/LP01CD.CPY".
       COPY "LIBLP/LP01CD_SQL.CPY".
       COPY "LIBLP/LPWSCD.CPY".
       COPY "LIBLP/LP01LN.CPY".
       COPY "LIBLP/LP01LN_SQL.CPY".
       COPY "LIBLP/LPWSLN.CPY".
       COPY "LIBLP/LP01LTI.CPY".
       COPY "LIBLP/LP01LTI_SQL.CPY".
       COPY "LIBLP/LPWSLTI.CPY".
       COPY "LIBLP/LP01LTP.CPY".
       COPY "LIBLP/LP01LTP_SQL.CPY".
       COPY "LIBLP/LPWSLTP.CPY".
       COPY "LIBGL/GL01GI.CPY".
       COPY "LIBGL/GL01GI_SQL.CPY".
       COPY "LIBGL/GLWSGI.CPY".
       COPY "LIBGB/GB01RC.CPY".
       COPY "LIBGB/GB01RC_SQL.CPY".
       COPY "LIBGB/GBWSRC.CPY".
       01  BP1-IFN             PIC X(3)     VALUE "BP1".
       01  WK-IFN              PIC X(2)     VALUE "WK".
       01  PR-IFN              PIC X(7)     VALUE "PRINTER".

       01  HOLD-LN-TOTPAYMNTD              PIC S9(7)V99 COMP-3.
       01  HOLD-PROG-BUF-BRANCH            PIC 9(4)    COMP.
       01  HOLD-BATCH-MULTIPLE-REFCDS      PIC X VALUE " ".
       01  HOLD-CD-BR-PAYOFF-FG            PIC X VALUE " ".
       01  HOLD-BP-PAYOFF-NONCASH          PIC X VALUE " ".
       01  HOLD-LBOX-PAYOFF-NONCASH        PIC X VALUE " ".
       01  HOLD-BP-ALLOW-PMT-ACCT-OTHBAL   PIC X VALUE " ".
       01  HOLD-LBOX-ALLOW-PMT-ACCT-OTHBAL PIC X VALUE " ".
       01  HOLD-CD-BR-POST-SS-TRCD         PIC X VALUE " ".
       01  WK-KEY              PIC 9(2)     VALUE 0.
       01  POSTING-ERRCD       PIC XX       VALUE " ".
       01  PAYMENT-PROG        PIC X(6)     VALUE SPACES.

       01  EXCEPTION-CODE      PIC X(02)    VALUE " ".
       01  LEV                 PIC 9(6)     COMP.
       01  TOT-POFF-REBATES    PIC S9(9)V99 COMP.

       01  ORIG-LN-LBOX        PIC X(01)    VALUE " ".
       01  ORIG-LN-ALLOTCD     PIC X(01)    VALUE " ".
       01  ORIG-BP-TRAMT       PIC S9(9)V99 VALUE 0.
       01  ORIG-LN-OT2BAL      PIC S9(9)V99 VALUE 0.
       01  HOLD-EW-PAYMENT-AMT PIC S9(9)V99 VALUE 0.

       01  BEG-BRANCH          PIC 9(04)    VALUE 0000.
       01  END-BRANCH          PIC 9(04)    VALUE 9999.
       01  TEST-USERID.
           03  FILLER          PIC X.
           03  USER-BR-1ST     PIC 9.
           03  FILLER          PIC X(7).

      * EXAMPLE; A0201TST
       01  ORIG-POSTNAME       PIC X(10).

       01  HOLD-EXT-FILPATH.
           03  FILLER                PIC X(13).
           03  HOLD-EXT-FILPATH-DATA PIC X(6).

      *-----------------------------------------------------------------
      * SPOOL DIRECTORY/FILENAME FOR EXCEPTION REPORT
      *-----------------------------------------------------------------
       01  EX-SPOOL.
           03  EX-SPOOL-BASE          PIC X(09).
           03  FILLER                 PIC X(01)   VALUE "/".
           03  EX-SPOOL-MACHINE       PIC X(02).
           03  FILLER                 PIC X(01)   VALUE "/".
           03  EX-SPOOL-DATA-PATH PIC X(6).
           03  FILLER             PIC X(04)  VALUE "/EO/".
           03  EX-SPOOL-PCODE     PIC X(03)  VALUE "REF".
           03  EX-SPOOL-DATE      PIC 9(06).
           03  EX-SPOOL-FILE.
               05  FILLER         PIC X(01).
               05  EX-SPOOL-STEP  PIC 9(04).
               05  EX-SPOOL-NAME  PIC X(06).
               05  EX-SPOOL-SUF   PIC X(02).

       01  SAVE-EX-SPOOL-NAME     PIC X(06).
       01  SUMMARY-SPOOL          PIC X(46).
       01  EXCEPT-SPOOL           PIC X(46).
       01  REPOEX-SPOOL           PIC X(46).


       01  STEP-COUNT             PIC 9999 VALUE 100.
       01  WORK-USERID.
          03  WORK-SECURITY        PIC X.
          03  WORK-BR              PIC 9(4).
          03  WORK-NAME            PIC X(5).

       01  HOLD-EW-SEQ          PIC 99 VALUE 0.

      *********************************************************
      *    MOVE ../../ED/CCFILMMDDBBB TO DONE SUB-DIRECTORY
       01  BT-PATH.
           03  BT-PATH-BASE          PIC X(09).
           03  FILLER                PIC X(01)   VALUE "/".
           03  BT-PATH-MACHINE       PIC X(02).
           03  FILLER                PIC X(04)   VALUE "/ED/".
           03  BT-PATH-SHORT-NAME    PIC X(5).
           03  BT-PATH-BATCH-DATE    PIC 9(4).
           03  BT-PATH-BATCH-NO      PIC 9(3).
       01  BT-DONE-PATH.
           03  BT-DONE-DIRECTORY.
               05  BT-DONE-BASE          PIC X(09).
               05  FILLER                REDEFINES BT-DONE-BASE.
                   07  BT-DONE-BASE-USR  PIC X(05).
                   07  BT-DONE-BASE-DIR  PIC X(04).
               05  FILLER                PIC X(01)   VALUE "/".
               05  BT-DONE-MACHINE       PIC X(02).
               05  FILLER                PIC X(09)   VALUE "/ED/DONE/".
           03  BT-DONE-FILENAME          PIC X(12).

      **********************
      *   LINE WORKERS     *
      **********************
       01  LN-COUNT1            PIC 999      VALUE 99.
       01  PAGE-NUMBER1         PIC 9(4)     VALUE 0.
       01  LN-COUNT2            PIC 999      VALUE 99.
       01  PAGE-NUMBER2         PIC 9(4)     VALUE 0.
       01  LN-COUNT3            PIC 999      VALUE 99.
       01  PAGE-NUMBER3         PIC 9(4)     VALUE 0.

       01  LN-FEED              PIC 99       VALUE 1.
       01  LN-WK                PIC 999      VALUE 999.

       01  BATCH-NO-LIST        PIC X(8)     VALUE "BATCHNO.".
       01  BATCH-REFCD-LIST     PIC X(11)    VALUE "BATCHREFCD.".
       01  SPOOL-REFCD-LIST     PIC X(8)     VALUE "BFREFCD.".
       01  SAVE-BP-WK-REFCD     PIC X(5)     VALUE SPACES.
       01  FIRST-TIME           PIC X        VALUE "Y".
       01  NAME-WORKER          PIC X(34).
       01  NOT-ON-FILE-FG       PIC X.
       01  MATCH-SSNO           PIC X        VALUE " ".
       01  PAYOFF-TRANS-FG      PIC X        VALUE " ".
       01  MESS-LIST            PIC X(5)     VALUE "MESS.".
       01  MESS-BUF.
           03  FILLER           PIC X(25).
           03  MESS-BRNO        PIC Z(4) VALUE ZERO.
           03  FILLER           PIC X(11).

       01  SUB                 PIC 9(6)      COMP-3 VALUE 0.
       01  SUB1                PIC 9(6)      COMP-3 VALUE 0.
       01  DUP-FLAG            PIC X         VALUE " ".
       01  OVPAID-FLAG         PIC X         VALUE " ".
       01  OVPAID-AMT          PIC S9(9)V99.
       01  TOTAL-TABLE OCCURS 2.
           03  TOTAL-READ          PIC 9(6)      COMP-3 VALUE 0.
           03  AMOUNT-READ         PIC S9(9)V99  COMP-3 VALUE 0.
           03  TOTAL-POSTED        PIC 9(6)      COMP-3 VALUE 0.
           03  AMOUNT-POSTED       PIC S9(9)V99  COMP-3 VALUE 0.
           03  TOTAL-EXCEPTION     PIC 9(6)      COMP-3 VALUE 0.
           03  AMOUNT-EXCEPTION    PIC S9(9)V99  COMP-3 VALUE 0.
           03  TOTAL-DUPS          PIC 9(6)      COMP-3 VALUE 0.
           03  AMOUNT-DUPS         PIC S9(9)V99  COMP-3 VALUE 0.
           03  TOTAL-OVPAID        PIC 9(6)      COMP-3 VALUE 0.
           03  AMOUNT-OVPAID       PIC S9(9)V99  COMP-3 VALUE 0.

       01  REPO-TOTAL-TABLE OCCURS 2.
           03  REPO-TOTAL-READ        PIC 9(6)      COMP-3 VALUE 0.
           03  REPO-AMOUNT-READ       PIC S9(9)V99  COMP-3 VALUE 0.
           03  REPO-TOTAL-POSTED      PIC 9(6)      COMP-3 VALUE 0.
           03  REPO-AMOUNT-POSTED     PIC S9(9)V99  COMP-3 VALUE 0.
           03  REPO-TOTAL-EXCEPTION   PIC 9(6)      COMP-3 VALUE 0.
           03  REPO-AMOUNT-EXCEPTION  PIC S9(9)V99  COMP-3 VALUE 0.
           03  REPO-TOTAL-DUPS        PIC 9(6)      COMP-3 VALUE 0.
           03  REPO-AMOUNT-DUPS       PIC S9(9)V99  COMP-3 VALUE 0.
           03  REPO-TOTAL-OVPAID      PIC 9(6)      COMP-3 VALUE 0.
           03  REPO-AMOUNT-OVPAID     PIC S9(9)V99  COMP-3 VALUE 0.

       01  TEST-AMT                PIC S9(9)V99  COMP   VALUE 0.
       01  NET-POFF-PRIN           PIC S9(9)V99  COMP   VALUE 0.
       01  WILL-POFF-ACCOUNT       PIC S9(9)V99  COMP   VALUE 0.
       01  VALID-POSTING-NOPOFF    PIC S9(9)V99  COMP   VALUE 0.

       01  DF-TEST             PIC X         VALUE " ".
           88 DF-POSTING                     VALUE "Y".

       01  REPO-CODE           PIC X         VALUE SPACES.

      * REVERSAL WORKERS
       01  VALID-REVERSAL-FG           PIC X VALUE " ".
       01  REVERSE-AFTER-RESCHED-FG    PIC X VALUE "N".
       01  REV-REFNO           PIC X(5)             VALUE " ".
       01  REV-TRCD            PIC XX.
           88  AD-POSTING      VALUE "AD" "A2" "A3" "A4"
                                     "A5" "A6" "A7" "A8"
                                     "A9".
           88  DF-POSTINGX     VALUE "DF" "D2" "D3" "D4"
                                     "D5" "D6" "D7" "D8"
                                     "D9".
           88  ADDON-POSTING   VALUE "LP" "NP" "ET" "RT" "ST".
           88  REBATE-POSTING  VALUE "RC" "RA" "RP" "R1"
                                     "R2" "R3" "RI" "RS"
                                     "RM" "RD".
       01  HOLD-REV-TRCD      REDEFINES REV-TRCD.
           03 FILLER           PIC X.
           03  TRCD-FTST       PIC X.
           03  TRCD-NODF      REDEFINES TRCD-FTST
                               PIC 9.

       01  CDV-BUF           VALUE " ".
           03  CDV-CD        PIC X(2) OCCURS 83.
       01  CDV-SUB           PIC 9(6) COMP-3.
           88 CDV-NO-MATCH   VALUE 0.
           88 CDV-MATCH      VALUE 1 THRU 100.
       01  CDV-17            PIC X(40) VALUE
           "OTWOAPJDPLP2P3P4P5PIPWTSTPSPACO2W2Z2BKBD".

      ***********************************
      *     P R I N T   B U F F E R S   *
      ***********************************
       01  HEAD1.
           03  H-DATE           PIC X(8)     VALUE " ".
           03  FILLER           PIC XX       VALUE " ".
           03  H-HR             PIC 99       VALUE 0.
           03  FILLER           PIC X        VALUE ":".
           03  H-MIN            PIC 99       VALUE 0.
           03  FILLER           PIC X(38)    VALUE " ".
           03  H-NAME           PIC X(40)    VALUE " ".
           03  FILLER           PIC X(30)    VALUE " ".
           03  FILLER           PIC X(5)     VALUE "PAGE ".
           03  H-PAGE-NO        PIC ZZZ9.

       01  HEAD2.
           03  FILLER           PIC X(10)    VALUE "USER ID:".
           03  H-USERID         PIC X(10).
           03  FILLER           PIC X(24)    VALUE " ".
           03  H-TITLE          PIC X(48)    VALUE
           "BATCH PROCESSING EXCEPTION REPORT FOR REF CODE: ".
           03  H-REFCD          PIC X(6).
           03  FILLER           PIC X(21)    VALUE " ".
           03  FILLER           PIC X(10)    VALUE "BATCH NO:".
           03  H-BATCH          PIC 999.

       01  HEAD3.
           03  FILLER      PIC X(23)    VALUE "BR #  ACCOUNT #".
           03  FILLER      PIC X(13)    VALUE "SOC-SEC-NO".
           03  FILLER      PIC X(21)    VALUE "NAME".
           03  FILLER      PIC X(6)     VALUE "REFCD".
           03  FILLER      PIC X(12)    VALUE "    AMOUNT  ".
           03  FILLER      PIC X(10)    VALUE "  DATE    ".
           03  HEAD3-VAR   PIC X(22)    VALUE " ".
           03  FILLER      PIC X(25)     VALUE "EXCEPTION".

       01  BRANCH-HEAD.
           03  FILLER           PIC X(10)    VALUE "BRANCH  :".
           03  H-BRANCH         PIC Z(4).
           03  FILLER           PIC X(3).
           03  H-BRDESC         PIC X(25).

       01  SUMMARY-HEAD.
           03  FILLER        PIC X(6)     VALUE "BR #  ".
           03  FILLER        PIC X(27)    VALUE "BRANCH NAME".
           03  FILLER        PIC X(9)     VALUE "   # READ".
           03  FILLER        PIC X(15)    VALUE "       AMT READ".
           03  FILLER        PIC X(9)     VALUE " #WRITTEN".
           03  FILLER        PIC X(15)    VALUE "    AMT WRITTEN".
           03  FILLER        PIC X(9)     VALUE " # ERRORS".
           03  FILLER        PIC X(15)    VALUE "     AMT ERRORS".
           03  FILLER        PIC X(9)     VALUE " # OVERPY".
           03  FILLER        PIC X(15)    VALUE "   AMT OVERPAID".

       01  DETAIL-LINE     PIC X(132) VALUE " ".
       01  D-LINE1 REDEFINES DETAIL-LINE.
           03  D-BRNO      PIC ZZZ9.
           03  FILLER      PIC XX.
           03  D-LOAN-NUM  PIC X(15).
           03  FILLER     REDEFINES D-LOAN-NUM.
               05  D-LNNO  PIC 9(8).
           03  FILLER      PIC XX.
           03  D-SSNO      PIC 999/99/9999.
           03  D-SSNOZ REDEFINES D-SSNO.
               05  D-SOC1      PIC X(3).
               05  FILLER      PIC X.
               05  D-SOC2      PIC XX.
               05  FILLER      PIC X.
               05  D-SOC3      PIC X(4).
           03  FILLER      PIC XX.
           03  D-NAME      PIC X(19).
           03  FILLER      PIC XX.
           03  D-REFCD     PIC X(6).
           03  D-TRAMT     PIC ZZZZZZ9.99-.
           03  FILLER      PIC X(01).
           03  D-PAYDATE   PIC 99/99/99.
           03  FILLER      PIC X(02).
           03  D-WORLD-FIELDS.
               05  D-CLAIM-NUMBER  PIC ZZ999999.
               05  FILLER          PIC X(02).
               05  D-PMT-TYPE      PIC X(10).
               05  FILLER          PIC X(02).
           03  D-EXCEPT    PIC X(25).
           03  FILLER     REDEFINES D-EXCEPT.
               05  D-OVEX  PIC X(15).
               05  D-OVPY  PIC ZZZZZ9.99-.

       01  SUMMARY-LINE REDEFINES DETAIL-LINE.
           03  S-BRNO        PIC 9999.
           03  FILLER        PIC XX.
           03  S-BRNAME      PIC X(25).
           03  FILLER        PIC XX.
           03  S-NO-READ     PIC ZZZZZ,ZZ9.
           03  S-AMT-READ    PIC ZZZZ,ZZZ,ZZ9.99.
           03  S-NO-WRITTEN  PIC ZZZZZ,ZZ9.
           03  S-AMT-WRITTEN PIC ZZZZ,ZZZ,ZZ9.99.
           03  S-NO-ERRORS   PIC ZZZZZ,ZZ9 BLANK ZERO.
           03  S-AMT-ERRORS  PIC ZZZZ,ZZZ,ZZ9.99 BLANK ZERO.
           03  FILLER        PIC XX.
           03  S-ERROR-DESC.
               05  S-NO-OVERPAY  PIC ZZZZZ,ZZ9 BLANK ZERO.
               05  S-AMT-OVERPAY PIC ZZZZ,ZZZ,ZZ9.99 BLANK ZERO.

       COPY "LIBLP/LPSTATW.CPY".
       COPY "LIBLP/LPBP_CMD.CPY".
       COPY "LIBLP/LPBPPATH.CPY".
       COPY "LIBLP/LPWKPATH.CPY".
       COPY "LIBLP/LPIBPCW.CPY".
       COPY "LIBLP/LPRATEW.CPY".
       COPY "LIBLP/LPXDTEW.CPY".
       COPY "LIBLP/LPLCASW.CPY".
       COPY "LIBLP/LPSCHDW.CPY".
       COPY "LIBGB/SPPDTHW.CPY".
       COPY "LIBLP/LPLCHGW.CPY".
       COPY "LIBLP/LPLCAPW.CPY".
       COPY "LIBLP/LPMDTEW.CPY".
       COPY "LIBLP/LPITRMW.CPY".
       COPY "LIBGB/DATERW.CPY".
       COPY "LIBLP/SETCTBLW.CPY".
       COPY "LIBGB/TIMEWK.CPY".
       COPY "LIBGB/REBATEW.CPY".
       COPY "LIBLP/LPPOFFW.CPY".
       COPY "LIBLP/ADDONSPRW.CPY".
       COPY "LIBGB/AGEINGW.CPY".
       COPY "LIBLP/LPUPWKW.CPY".
       COPY "LIBLP/LPCEPPW.CPY".
       COPY "LIBLP/LPAMTSW.CPY".
       COPY "LIBLP/LPPDUEW.CPY".
       COPY "LIBLP/DEFPOLW.CPY".
       COPY "LIBLP/LPAPRSW.CPY".
       COPY "LIBLP/LPAPRZW.CPY".
       COPY "LIBLP/LPUPERW.CPY".
       COPY "LIBLP/POSTDATEW.CPY".
       COPY "LIBGB/GETENVW.CPY".
       COPY "LIBGB/ACCESSW.CPY".
       COPY "LIBGB/DACCESSW.CPY".
       COPY "LIBGB/SYSTEMW.CPY".
       COPY "LIBGB/CONNECTW_SQL.CPY".
       COPY "LIBGB/FILEWK.CPY".
       COPY "LIBGB/MESSWK.CPY".
       COPY "LIBGB/MKTEMPW_CMD.CPY".
       COPY "LIBGB/GETPRW.CPY".
       COPY "LIBGB/RBACTW.CPY".
       COPY "LIBGB/GPENVW.CPY".
       COPY "LIBLP/LPEDPATH.CPY".

       COPY "LIBGB/SCREENW.CPY".
       COPY "LIBLP/LONPW9_DEF.CPY".
       COPY "LIBLP/LONPW9_WKS.CPY".
       COPY "LIBGB/CONAME_EXT.CPY".
       COPY "LIBGB/HELPLINK.CPY".
       COPY "LIBGB/PRU_LNK.CPY".
      **************************************************
      *   C O N T R O L   M O D U L E                  *
      **************************************************
       COPY "LIBGB/GETFMW.CPY".
       COPY "LIBLP/LPLOANW.CPY".
       COPY "LIBLP/LPPFBUF.CPY".

       SCREEN SECTION.
       COPY "LIBLP/LONPW9_SCN.CPY".

       PROCEDURE DIVISION
             USING FORM-PATHNAME EXIT-PATHNAME PROG-BUF UPDATE-BUF.
       DECLARATIVES.
       DECLARE-ERROR SECTION.
           USE AFTER ERROR PROCEDURE ON
              WK-FILE BP-FILE PR-FILE OP-FILE.
       COPY "LIBGB/DECLARE.CPY".
           PERFORM CLOSE-SP1-FILE.
           PERFORM CLOSE-LTP1-FILE.
           PERFORM CLOSE-LTI1-FILE.
           PERFORM CLOSE-LP1-FILE.
           PERFORM CLOSE-LN1-FILE.
           PERFORM CLOSE-LXE1-FILE.
           PERFORM CLOSE-LXG1-FILE.
           PERFORM CLOSE-LP1-FILE.
           PERFORM CLOSE-CD1-FILE.
           PERFORM CLOSE-BW1-FILE.
           PERFORM CLOSE-GI1-FILE.
           PERFORM CLOSE-RC2-FILE.
           PERFORM CLOSE-BR-FILE.
           PERFORM CLOSE-GB-FILE.
           CLOSE WK-FILE BP-FILE PR-FILE OP-FILE.
       COPY "LIBGB/DECLAR2.CPY".

      ******************************************************************
      *
      *  PROGRAM CONTROL
      *
      ******************************************************************
       MAIN-PROGRAM SECTION.

           PERFORM SQL-CONNECT.

      D    STOP MESS.
           MOVE FORM-PATHNAME TO FORM-PATH.
           MOVE "LONPW9" TO VDU-FORM-NAME.

           IF ( EXT-ROUTE-BUF = "00" )
              PERFORM FORM-RESET.

           PERFORM GET-GPENV.

           MOVE EXT-FILPATH TO HOLD-EXT-FILPATH.
           ACCEPT ORIG-POSTNAME FROM ENVIRONMENT "POSTNAME".

           PERFORM INITIALIZATION.
           IF ERRCD NOT = " "
              GO TO END-PROGRAM.

           MOVE 0 TO BEG-BRANCH.
           MOVE 9999 TO END-BRANCH.

           MOVE BEG-BRANCH TO BR-NO.
           PERFORM START-BR-FILE.

       NEXT-GROUP-LOC.
           PERFORM READ-BR-FILE-NEXT.

           IF IO-FG = 9 OR BR-NO > END-BRANCH
              GO TO END-ROUTINE.

           IF HOLD-CD-BR-PAYOFF-FG = "Y"
              MOVE "N" TO HOLD-BP-ALLOW-PMT-ACCT-OTHBAL
                          HOLD-LBOX-ALLOW-PMT-ACCT-OTHBAL
              MOVE "Y" TO HOLD-BP-PAYOFF-NONCASH
                          HOLD-LBOX-PAYOFF-NONCASH
           ELSE
              MOVE BR-BP-ALLOW-PMT-ACCT-OTHBAL TO
                                    HOLD-BP-ALLOW-PMT-ACCT-OTHBAL
              MOVE BR-LBOX-ALLOW-PMT-ACCT-OTHBAL TO
                                    HOLD-LBOX-ALLOW-PMT-ACCT-OTHBAL
              MOVE BR-BP-PAYOFF-NONCASH TO
                                    HOLD-BP-PAYOFF-NONCASH
              MOVE BR-LBOX-PAYOFF-NONCASH TO
                                    HOLD-LBOX-PAYOFF-NONCASH.

           PERFORM SET-BRANCH-HEADINGS.

      * ONLY PROCESS FILES FOR THE MACHINE I'M ON

           IF BR-MACHINE NOT = EXT-FILPATH-MACHINE
              GO TO NEXT-GROUP-LOC.

       MOVE-BRANCH-PATH-INFO.

           MOVE EXT-FILPATH-BASE           TO FILPATH-BASE.
           MOVE BR-MACHINE                 TO FILPATH-MACHINE.
           MOVE BR-DATA-PATH               TO FILPATH-DATA.

           MOVE "B"                        TO BW-PATH-OVERRIDE
                                              LN-PATH-OVERRIDE
                                              BP-PATH-OVERRIDE
                                              GB-PATH-OVERRIDE
                                              LP-PATH-OVERRIDE
                                              LXE-PATH-OVERRIDE
                                              LXG-PATH-OVERRIDE.

      * SETUP BP FILE PATH
      * GET REFCD OF BP FILE IN LOCAL 'ED'

           MOVE " "              TO BP-ALL-SUBPATH.
           MOVE BR-NO            TO BP-ALL-BRANCH.
           MOVE TRANS-DATE       TO NUM-DATE.
           MOVE 0    TO NUM-CCYY.
           MOVE NUM-DATE         TO BP-ALL-DATE.
           MOVE BATCH            TO BP-ALL-BATCH-NO.
           MOVE SAVE-BP-WK-REFCD TO BP-ALL-REFCD.
           PERFORM LOAD-BP1-FILE.
           MOVE BP-PATH TO ACCESS-BUF.

      * PERFORM ACCESS CALL TO DETERMINE IF THE BRANCH HAS AN
      * ALLOTMENT/LBOX REFERENCE PAYMENT FILE (BP)

           PERFORM ACCESS-CALL.
           IF STAT NOT = "00"
              GO TO NEXT-GROUP-LOC.

      * DISPLAY STATUS FOR EVERY BRANCH THAT HAS A BP FILE, VALID OR NOT

           IF ( EXT-ROUTE-BUF = "00" )
              MOVE "UPDATE IN PROGRESS......." TO MESS-BUF
              MOVE BR-NO TO MESS-BRNO
              MOVE MESS-BUF TO WR-BUF
              MOVE MESS-LIST TO WR-LIST
              PERFORM CALL-WRFORM.

      * NEED FOR LCAS ROUTINES (REPLACES GLOBRD)
           PERFORM OPEN-GB-FILE.
           MOVE GB-PATH-OWNBR TO GB-BRNO.
           MOVE 1             TO GB-NO.
           PERFORM READ-GB-FILE.
           PERFORM CLOSE-GB-FILE.
           IF IO-BAD
              GO TO NEXT-GROUP-LOC.

           PERFORM OPEN-LN1-FILE.
           PERFORM OPEN-BW1-FILE.

      * CHANGE THE EXTERNAL FILPATH TO THAT OF THE CURRENT BRANCH.

           MOVE BR-MACHINE            TO EXT-FILPATH-MACHINE.
           MOVE BR-DATA-PATH          TO EXT-FILPATH-DATA.
           SET ENVIRONMENT "FIL"      TO EXT-FILPATH-FIL.
           MOVE ORIG-POSTNAME         TO WORK-USERID.
           MOVE BR-NO                 TO WORK-BR.
           SET ENVIRONMENT "POSTNAME" TO WORK-USERID.
           MOVE BR-NO                 TO BRANCH.

      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      * WARNING * WARNING * WARNING * WARNING * WARNING * WARNING * WARNING *
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      *                                                                     *
      * FROM THIS POINT FORWARD THE USER HAS BE PLACED, LOGICALLY, INTO     *
      * THE BRANCH FOR WHICH HE/SHE IS POSTING FOR.                         *
      *                                                                     *
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
      * WARNING * WARNING * WARNING * WARNING * WARNING * WARNING * WARNING *
      * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

      * TEST RC-STATUS FOR OPEN DAY

           MOVE "A1" TO RC-STATUS.
           MOVE BR-NO TO RC-BRNO.

           MOVE TRANS-DATE TO RC-TRANS-DATE.

           PERFORM OPEN-RC2-FILE.
           PERFORM READ-RC2-FILE.
           PERFORM CLOSE-RC2-FILE.
           IF IO-FG NOT = 0
              MOVE "A1" TO EXCEPTION-CODE
              PERFORM BRANCH-EXCEPTION
              GO TO END-OF-GROUP.

      * DAY IS OPEN, RESERVE OP FILE SO THE DAY CANNOT BE CLOSED.

           MOVE TRANS-DATE TO DATE-YYYYMMDD.
           PERFORM CONVERT-YYYYMMDD-TO-MMDDYY.
           MOVE BR-NO       TO OPEN-PATH-BRNO.
           MOVE DATE-MMDDYY TO OPEN-PATH-TRDATE.
           PERFORM LOAD-OPEN-FILE.
           MOVE OPEN-PATH TO ACCESS-BUF.
           PERFORM ACCESS-CALL.
           IF STAT NOT = "00"
              MOVE "OP" TO EXCEPTION-CODE
              PERFORM BRANCH-EXCEPTION
              GO TO END-OF-GROUP.

           PERFORM OPEN-OP-FILE.

           PERFORM OPEN-BP1-FILE.
           MOVE 0 TO BP-LNNO BP-SEQNO.

           PERFORM START-BP1-FILE.

       MAIN-READ-BP1-NEXT.
           PERFORM READ-BP1-FILE-NEXT.

           IF IO-FG NOT = 0
              PERFORM CLOSE-LN1-FILE
              PERFORM CLOSE-BW1-FILE
              GO TO END-OF-GROUP.

      * SKIP THE HEADER RECORD

           IF BP-LNNO = 0
              UNLOCK BP-FILE
              GO TO MAIN-READ-BP1-NEXT.

           ADD 1 TO TOTAL-READ(1) TOTAL-READ(2).
           ADD BP-TRAMT TO AMOUNT-READ(1) AMOUNT-READ(2).

           IF (BP-PAYDATE = 20202020 OR BP-PAYDATE = 02020202
                 OR BP-PAYDATE = 0)
              MOVE TRANS-DATE TO BP-PAYDATE.


           MOVE " "      TO DUP-FLAG
                            OVPAID-FLAG.
           MOVE 0        TO OVPAID-AMT HOLD-OVPAID-CHECK.
           MOVE BP-TRAMT TO ORIG-BP-TRAMT.
           MOVE " " TO POSTING-ERRCD
                       D-EXCEPT.

      * LNNO OF ALL 9'S ARE ALL ZEROS

           IF BP-LNNO = 99999999
              MOVE "Y" TO NOT-ON-FILE-FG
              MOVE "TOTAL OF ALL ZERO ACCTNO'S" TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              GO TO MAIN-READ-BP1-NEXT.

           IF BP-UPDFG = "U" OR "E"
              UNLOCK BP-FILE
              GO TO MAIN-READ-BP1-NEXT.

           MOVE " " TO NOT-ON-FILE-FG.

           IF (BR-AUTO-PL-REF-AC = "Y" OR "2" OR "3")
              IF (BP-TRCD = "PL" OR "P2" OR "P3")
                 MOVE "AUTO ACCELERATE FG:REJECT" TO D-EXCEPT
                 MOVE "Y" TO NOT-ON-FILE-FG
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

           IF BP-TRCD =  "PL" OR "P2" OR "P3"
              MOVE BP-PAYDATE TO NUM-DATE
              MOVE TRANS-DATE TO SYS-DATE
                 IF NOT(NUM-MO = S-MM AND NUM-CCYY = S-CCYY)
                 MOVE "BACK DATE IN PRIOR MO" TO D-EXCEPT
                 MOVE "Y" TO NOT-ON-FILE-FG
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

           MOVE BR-NO   TO LN-OWNBR.
           MOVE BP-LNNO TO LN-ACCTNO.
           PERFORM READ-LN1-FILE.
           IF IO-FG NOT = 0
              MOVE "Y" TO NOT-ON-FILE-FG
              MOVE "ACCOUNT NOT ON FILE" TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              GO TO MAIN-READ-BP1-NEXT.

           IF LN-ESCROW-FG = "Y"
              MOVE "ACCOUNT HAS ESCROW" TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              GO TO MAIN-READ-BP1-NEXT.

           IF BP-TRCD = "RV"
              PERFORM VALIDATE-REVERSAL
              IF VALID-REVERSAL-FG NOT = "Y"
                 GO TO MAIN-READ-BP1-NEXT.

           IF LN-BNKRPTDATE NOT = 0
              IF BP-TRCD = "BK"
                 MOVE "BK: ACCT ALREADY BANKRUPT" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

           IF LN-BNKRPTDATE = 0
              IF BP-TRCD = "BD"
                 MOVE "BD: ACCT NOT BANKRPT STAT" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

           IF BP-TRCD =  "PL" OR "P2" OR "P3"
              IF LN-PLCD = "P"
                 MOVE "ACCT ALREADY ACTIVE P&L" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

           IF BP-TRCD = "RE"
               IF GP-REPO-CODE NOT = "A"
                  MOVE "MUST HAVE REPO OPTIONS TURNED ON" TO D-EXCEPT
                  PERFORM MAIN-EXCEPTION
                  GO TO MAIN-READ-BP1-NEXT.

           IF BP-TRCD = "RE"
               IF NOT (LN-REPOCD = "X" OR "S")
                  MOVE "RE: ACCT NOT REPO STATUS!" TO D-EXCEPT
                  PERFORM MAIN-EXCEPTION
                  GO TO MAIN-READ-BP1-NEXT.

           IF BP-TRCD = "RE"
              MOVE BP-PAYDATE TO IBPC-DATE
              PERFORM IBPC-TEST
              IF NOT (IBPC-FG = "I" OR LN-LOANTYPE = "I")
                  MOVE "RE: ACCT NOT INTEREST BEARING!" TO D-EXCEPT
                  PERFORM MAIN-EXCEPTION
                  GO TO MAIN-READ-BP1-NEXT.

      * "R" REJECT

           IF HOLD-CD-BR-POST-SS-TRCD = "R"
               IF LN-REPOCD = "X"
                  MOVE "REPO BATCH RECORD"        TO D-EXCEPT
                  PERFORM MAIN-EXCEPTION
                  PERFORM REPO-EXCEPTION
                  GO TO MAIN-READ-BP1-NEXT.

           IF HOLD-CD-BR-POST-SS-TRCD = "Y"
               IF LN-REPOCD NOT = "X"
                  MOVE "NON REPO BATCH RECORD!"  TO D-EXCEPT
                  PERFORM MAIN-EXCEPTION
                  GO TO MAIN-READ-BP1-NEXT.

      * SAVE ORIG VALUES

           MOVE LN-LBOX    TO ORIG-LN-LBOX.
           MOVE LN-ALLOTCD TO ORIG-LN-ALLOTCD.
           MOVE LN-OT2BAL  TO ORIG-LN-OT2BAL.

      * SETUP LBOX/ALLOTCD HERE FOR CORRECT LATE CHARGE CALCULATIONS

           MOVE "N"        TO LN-LBOX.
           MOVE "Y"        TO LN-ALLOTCD.

      * CLEAR HOLD-BP-TRCD HERE:
      *  - IF AN EXCEPTION CAUSING A NON CASH TRASACTION REQUIREMENT
      *       IS FOUND AND BR-????-PAYOFF-NONCASH = "Y", THAN "99"
      *       WILL BE PUT INTO HOLD-BP-TRCD TO INDICATE A CALL TO
      *       LONPFA.C SHOULD BE DONE AND NOT A CALL TO LONPFC.C

           MOVE " " TO HOLD-BP-TRCD.

           MOVE " " TO MATCH-SSNO.
           IF BP-SSNO = LN-SSNO(1)
              MOVE "Y" TO MATCH-SSNO
           ELSE
           IF BP-SSNO = LN-SSNO(2)
              MOVE "Y" TO MATCH-SSNO
           ELSE
           IF BP-SSNO = LN-SSNO(3)
              MOVE "Y" TO MATCH-SSNO
           ELSE
           IF BP-SSNO = LN-SSNO(4)
              MOVE "Y" TO MATCH-SSNO.
           IF MATCH-SSNO = " "
              MOVE "SSNO'S DO NOT MATCH" TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              GO TO MAIN-READ-BP1-NEXT.

      * IF FILE CONTAINS MULTIPLE REFCDS, MUST READ
      * REFCD FOR THIS BATCH PAYMENT RECORD

           IF HOLD-BATCH-MULTIPLE-REFCDS = "Y"
              MOVE "BR"        TO CD-TYPE
              MOVE BP-REFCD    TO CD-CODE
              PERFORM READ-CD1-FILE
              IF IO-BAD OR (CD-BR-FILE-TYPE = "C")
                 MOVE "INVALID BP REFCD: &&&&&!" TO D-EXCEPT
                 INSPECT D-EXCEPT REPLACING FIRST "&&&&&" BY BP-REFCD
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT
              ELSE
                 MOVE CD-BR-LC-FG TO BATCH-REFCD-LC-FG
                 MOVE BP-REFCD TO BATCH-REFCD LP-REFNO.

      * ADDED ABILITY TO SEND NEGATIVES, IF 1ST BYTE OF AMT  IS "-",
      * BUT BP-ALLOW-NEGATIVE FLAG MUST ALSO BE Y, NEEDED FOR RE'S
      * (REGACC PR#382). ERROR IF NEG BUT FLAG NOT SET:

           IF BP-TRAMT < 0
              IF BP-ALLOW-NEGATIVE NOT = "Y"
                 MOVE "NEGATIVE BUT FLAG NOT SET" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION        
                 GO TO MAIN-READ-BP1-NEXT.

      * TEST FOR PAYMENT AMOUNT = 0.00

           IF NOT (CD-BR-FILE-TYPE = "B" OR "P")
              IF BP-ALLOW-NEGATIVE NOT = "Y"
                 IF BP-TRAMT NOT > 0
                    IF (BP-TRCD = "DF" OR "D2" OR "D3" OR "D4"
                               OR "D5" OR "D6" OR "D7" OR "D8" OR "D9")
                        IF BP-ALLOW-ZERO-DF NOT = "Y"
                           MOVE "PAYMENT MUST BE > 0" TO D-EXCEPT
                           PERFORM MAIN-EXCEPTION
                           GO TO MAIN-READ-BP1-NEXT
                        END-IF
                    ELSE
                        MOVE "PAYMENT MUST BE > 0" TO D-EXCEPT
                        PERFORM MAIN-EXCEPTION
                        GO TO MAIN-READ-BP1-NEXT.

           IF HOLD-CD-BR-POST-SS-TRCD = "Y"
              IF BP-AUCTION-FEES = ZEROS
                 MOVE "MISSING AUCTION FEES" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

      * TEST IF ODD PAYMENTS ARE NOT ALLOWED:
      * CHECK BR-BP-ODDPAY (NOT LBOX) IF ALLOTMENT

           IF ( (CD-BR-ALLOT-OPTION = "Y") AND
                (BR-BP-ODDPAY NOT = "Y"  )
              )
              OR
              ( (CD-BR-LBOX-OPTION = "Y" ) AND
                (BR-LBOX-ODDPAY NOT = "Y")
              )
              IF LN-1STPYAMT NOT = 0
                 IF LN-TOTPAYMNTD = 0
                    IF BP-TRAMT NOT = LN-1STPYAMT
                       MOVE "IRREGULAR PAYMENT AMOUNT" TO D-EXCEPT
                       PERFORM MAIN-EXCEPTION
                       GO TO MAIN-READ-BP1-NEXT
                    ELSE
                       NEXT SENTENCE
                 ELSE
                    IF BP-TRAMT NOT = LN-REGPYAMT
                       MOVE "IRREGULAR PAYMENT AMOUNT" TO D-EXCEPT
                       PERFORM MAIN-EXCEPTION
                       GO TO MAIN-READ-BP1-NEXT
                    ELSE
                       NEXT SENTENCE
              ELSE
                 IF BP-TRAMT NOT = LN-REGPYAMT
                    MOVE "IRREGULAR PAYMENT AMOUNT" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.
    
      * WHEN BR-BP/LBOX-ALLOW-PMT-ACCT-OTHBAL = "Y", ALLOW THE BATCH
      * PAYMENT TO BE APPLIED TO THE ACCOUNT BUT NOT TO OTHER BALANCE

      * WHEN CD-BR-OT-GL-ACCT NOT = 0, ALLOW POSTING TO ACCOUNTS WITH
      * LN-OTHBAL, OTHERWISE, TEST IF OTHER CHARGES EXIST AND
      * PERFORM MAIN-EXCEPTION

           IF ( CD-BR-OT-GL-ACCOUNTS = " " ) OR
              ( CD-BR-OT-GL-ACCT = 0       )
              IF LN-OTHBAL NOT = 0
                 IF ( ( CD-BR-ALLOT-OPTION = "Y"              ) AND
                      ( HOLD-BP-ALLOW-PMT-ACCT-OTHBAL NOT = "Y" )
                    )
                    OR
                    (
                      ( CD-BR-LBOX-OPTION = "Y"                 ) AND
                      ( HOLD-LBOX-ALLOW-PMT-ACCT-OTHBAL NOT = "Y" )
                    )
                    MOVE "LOAN HAS OTHER CHARGES" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

           IF LN-OT2BAL NOT = 0
              IF ( ( CD-BR-ALLOT-OPTION = "Y"              ) AND
                   ( HOLD-BP-ALLOW-PMT-ACCT-OTHBAL = "2" )
                 )
                 OR
                 (
                   ( CD-BR-LBOX-OPTION = "Y"                 ) AND
                   ( HOLD-LBOX-ALLOW-PMT-ACCT-OTHBAL = "2" )
                 )
                 MOVE "LOAN HAS OTHER 2 CHARGES" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

      * TEST IF ACCOUNT BELONGS TO POSTING BRANCH:

           IF LN-OWNBR NOT = BR-NO
              MOVE "ACCOUNT OWNED BY OTHER BR" TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              GO TO MAIN-READ-BP1-NEXT.
           
           IF BP-FROZEN-OVERRIDE NOT = "Y"
              IF LN-ACCT-FROZEN = "Y"
                 MOVE "ACCOUNT IS FROZEN" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

      * TEST IF PAYMENT WILL ONLY COVER LC AND INTEREST:
      * CHECK BR-BP-NOPRIN (NOT LBOX) IF ALLOTMENT

           IF ( (CD-BR-ALLOT-OPTION = "Y") AND
                (BR-BP-NOPRIN NOT = "Y"  ) )
              OR
              ( (CD-BR-LBOX-OPTION = "Y" ) AND
                (BR-LBOX-NOPRIN NOT = "Y") )
                 COMPUTE TEST-AMT = LN-INTBAL + LN-LCBAL
                 IF BP-TRAMT NOT > TEST-AMT
                    MOVE "APPLIES WITH NO PRINCIPAL" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

      * TEST IF PL ACCOUNTS ARE ALLOWED:

           IF ( (CD-BR-ALLOT-OPTION = "Y") AND
                ( NOT (BR-BP-PL = "Y" OR "P") ) )
              OR
              ( (CD-BR-LBOX-OPTION = "Y" ) AND
                ( NOT (BR-LBOX-PL = "Y" OR "P") ) )
                 IF LN-PLDATE NOT = 0
                    MOVE "P&L ACCOUNT " TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

           IF LN-PLCD = "I"
              MOVE "INACTIVE P&L ACCOUNT " TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              GO TO MAIN-READ-BP1-NEXT.

      * TEST IF JD ACCOUNTS ARE ALLOWED:
      * CHECK BR-BP-JD (NOT LBOX) IF ALLOTMENT

           IF ( (CD-BR-ALLOT-OPTION = "Y") AND
                (BR-BP-JD NOT = "Y"      )
              )
              OR
              ( (CD-BR-LBOX-OPTION = "Y" ) AND
                (BR-LBOX-JD NOT = "Y"    )
              )
              IF LN-JDDATE NOT = 0
                 MOVE "JUDGEMENT ACCOUNT " TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

      * TEST IF ACCOUNTS WITH MESSAGE ARE ALLOWED:
      * CHECK BR-BP-FLASH (NOT LBOX) IF ALLOTMENT

           IF ( (CD-BR-ALLOT-OPTION = "Y") AND
                (BR-BP-FLASH NOT = "Y"   )
              )
              OR
              ( (CD-BR-LBOX-OPTION = "Y" ) AND
                (BR-LBOX-FLASH NOT = "Y" )
              )
              IF LN-MESSAGE NOT = " "
                 MOVE "FLASHING MESSAGE  " TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

      * TEST IF ACCOUNTS WITH ACTION CODE ARE ALLOWED:

           IF ( (CD-BR-ALLOT-OPTION = "Y"  ) AND
                (BR-BP-ACTIONCD NOT = "Y"  )
              )
              OR
              ( (CD-BR-LBOX-OPTION = "Y"   ) AND
                (BR-LBOX-ACTIONCD NOT = "Y")
              )
              IF LN-ACTIONCD NOT = " "
                 MOVE "ACTION CODE ON ACCOUNT" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

           PERFORM GET-SPR.
           IF IO-FG NOT = 0
              MOVE "INVALID SPR RECORD" TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              GO TO MAIN-READ-BP1-NEXT.

      * REJECT IF THE INTEREST PAID THRU ON AN IB LOAN IS GREATER
      * THAN THE POSTING DATE

           MOVE BP-PAYDATE TO IBPC-DATE.
           PERFORM IBPC-TEST.
           IF (IBPC-FG = "I" OR LN-LOANTYPE = "I")
               IF LN-INTPDTH-DATE > BP-PAYDATE
                  MOVE "INTEREST PAID THRU DATE" TO D-EXCEPT
                  PERFORM MAIN-EXCEPTION
                  GO TO MAIN-READ-BP1-NEXT.

           IF BP-TRCD = "DF" OR "D2" OR "D3" OR "D4" OR "D5"
                             OR "D6" OR "D7" OR "D8" OR "D9"
              MOVE "Y" TO DF-TEST
           ELSE
              MOVE " " TO DF-TEST.

           IF DF-POSTING
              IF BP-TRAMT < SP-DEFMIN OR
                      BP-TRAMT > SP-DEFMAX
                 MOVE "SPR DEFERMENT MIN/MAX" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

      * ONLY ALLOWING REGIONAL'S SP-DEFFRMLA 0,2,3,96,97,99

           IF DF-POSTING
              IF NOT (SP-DEFFRMLA = 0 OR 2 OR 3 OR 96 OR 97 OR 99)
                 MOVE "DF FRMLA INVALID FOR BATCH" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

      * NO MULTIPLES WITH 96 OR D7
           IF DF-POSTING
              IF SP-DEFFRMLA = 96 OR 97
                 IF BP-TRCD NOT = "DF"
                    MOVE "MULTIPLE DF'S NOT ALLOWED" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

           IF DF-POSTING
             IF BP-IGNORE-DEFPOL NOT = "Y"
                MOVE BP-TRCD    TO DEFPOL-TRCD
                MOVE TRANS-DATE TO DEFPOL-DATE
                PERFORM VALIDATE-DF-POLICY
                IF DEFPOL-MAXIMUM = "X"
                   MOVE "DEFERMENTS WILL EXCEED ORIGINAL TERM" TO
                                                      D-EXCEPT
                   PERFORM MAIN-EXCEPTION
                   GO TO MAIN-READ-BP1-NEXT
                ELSE
                IF DEFPOL-MAXIMUM = "R"
                   MOVE "MINIMUM MONTHS HAVE NOT ELAPSED" TO D-EXCEPT
                   PERFORM MAIN-EXCEPTION
                   GO TO MAIN-READ-BP1-NEXT
                ELSE
                IF DEFPOL-MAXIMUM = "Y"
                   MOVE "DF NOT ALLOWED" TO D-EXCEPT
                   PERFORM MAIN-EXCEPTION
                   GO TO MAIN-READ-BP1-NEXT.

      * TEST IF MAXIMUM CONTRACTUAL IS EXCEEDED:

           MOVE BP-PAYDATE TO AGEING-DATE.
           PERFORM COMPUTE-CONTRACTUAL.
           PERFORM COMPUTE-RECENCY.

            IF BP-TRCD = "PL" OR "P2" OR "P3"
               IF CONTRACTUAL < 30
                   MOVE "CONTRACTUAL < 30" TO D-EXCEPT
                   PERFORM MAIN-EXCEPTION
                   GO TO MAIN-READ-BP1-NEXT.

            IF BP-TRCD = "PL" OR "P2" OR "P3"
               IF RECENCY < 30
                   MOVE "RECENCY < 30" TO D-EXCEPT
                   PERFORM MAIN-EXCEPTION
                   GO TO MAIN-READ-BP1-NEXT.

           IF CD-BR-ALLOT-OPTION = "Y"
              IF BR-BP-MAXCON NOT = 999
                IF CONTRACTUAL > BR-BP-MAXCON
                   MOVE "EXCEEDS MAX CONTRACTUAL" TO D-EXCEPT
                   PERFORM MAIN-EXCEPTION
                   GO TO MAIN-READ-BP1-NEXT.

           IF CD-BR-LBOX-OPTION = "Y"
              IF BR-LBOX-MAXCON NOT = 999
                 IF CONTRACTUAL > BR-LBOX-MAXCON
                    MOVE "EXCEEDS MAX CONTRACTUAL" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

      * TEST IF MAXIMUM RECENCY IS EXCEEDED:

           IF CD-BR-ALLOT-OPTION = "Y"
              IF BR-BP-MAXREC NOT = 999
                IF RECDEL > BR-BP-MAXREC
                   MOVE "EXCEEDS MAX RECENCY" TO D-EXCEPT
                   PERFORM MAIN-EXCEPTION
                   GO TO MAIN-READ-BP1-NEXT.

              IF CD-BR-LBOX-OPTION = "Y"
                 IF BR-LBOX-MAXREC NOT = 999
                    IF RECDEL > BR-LBOX-MAXREC
                       MOVE "EXCEEDS MAX RECENCY" TO D-EXCEPT
                       PERFORM MAIN-EXCEPTION
                       GO TO MAIN-READ-BP1-NEXT.

      * DON'T ALLOW POSTING WHEN LOAN HAS ZERO BALANCE
      * THIS CHECK WAS DOWN AFTER ALL THE PAYOFF STUFF,
      * NOT SURE WHY, I LEFT IT THERE BUT WORLD WANTS TO SEE ZERO
      * BALANCE MESSAGE INSTEAD OF PMT EXCEED PAYOFF MESSAGE, SO
      * YOU CAN LOOK AT EXCEPTION REPORT & SEE PAID OUTS VS.
      * LOANS WITH BALANCE TOO LOW FOR BATCH PMT.  BARB

           IF LN-CURBAL = 0
              IF CD-BR-ALLOT-OPTION = "Y"
                 IF HOLD-BP-PAYOFF-NONCASH NOT = "Y"
                    MOVE "ALREADY ZERO BALANCE" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

           IF LN-CURBAL = 0
              IF CD-BR-LBOX-OPTION = "Y"
                 IF HOLD-LBOX-PAYOFF-NONCASH NOT = "Y"
                    MOVE "ALREADY ZERO BALANCE" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

           IF CD-BR-FILE-TYPE = "B" OR "P"
              GO TO SKIP-PAYOFF-CALC.

           IF VALID-REVERSAL-FG = "Y"
              GO TO SKIP-PAYOFF-CALC.

      * SET REB-LPTRCD FOR LPPOFF WHICH CALLS REBATE
      * NEED TO KNOW 'PB', 'RN', AND 'SC'
      * FOR SUN FINANCE SPOPT1 = 2:

           MOVE "PO"              TO REB-LPTRCD
                                     POFF-LPTRCD.
           MOVE BP-PAYDATE        TO POFF-PAYDATE.
           MOVE LN-MAKERCD(1)     TO POFF-MAKERCD.
           MOVE BATCH-REFCD       TO POFF-LCAP-BATCH-REFCD.
           MOVE BATCH-REFCD-LC-FG TO POFF-LCAP-BATCH-REFCD-LC-FG.
           PERFORM PAYOFF-LOAN-ROUTINE.

      * COMPILE TOTAL PAYOFF REBATES FOR FURTHER TESTING:

           MOVE 0 TO TOT-POFF-REBATES.
           PERFORM VARYING SUB FROM 1 BY 1 UNTIL SUB > 13
              ADD POFF-REBATE(SUB) TO TOT-POFF-REBATES
           END-PERFORM.

      * DETERMINE NET PAYOFF PRINCIPAL:

           COMPUTE NET-POFF-PRIN =
              LN-CURBAL - LN-OT2BAL + LN-OTHBAL - TOT-POFF-REBATES.

      * DETERMINE AMOUNT THAT WILL PAYOFF ACCOUNT:

           COMPUTE WILL-POFF-ACCOUNT =
              NET-POFF-PRIN + POFF-INTDUE + POFF-LCDUE.

      * DETERMINE TRAMT THAT CAN BE POSTED LEAVING $0.01 IN PRINCIPAL:

           COMPUTE VALID-POSTING-NOPOFF = WILL-POFF-ACCOUNT - 0.01.

      * TEST IF PAYMENT WILL BRING BALANCE BELOW A NET PAYOFF:

           IF BP-TRAMT > POFF-NETDUE
              IF LN-PLDATE NOT = 0
                 IF ( CD-BR-ALLOT-OPTION = "Y" AND
                      BR-BP-PL = "P" )
                    OR
                    ( CD-BR-LBOX-OPTION = "Y" AND
                      BR-LBOX-PL = "P" )
                    MOVE "PAY EXCEEDS PAYOFF AMT" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

      * TEST IF PAYMENT WILL BRING BALANCE BELOW THE CURRENT LOAN
      * BALANCE

           IF BP-TRAMT > (LN-CURBAL - LN-OT2BAL) - .01
              IF LN-PLDATE NOT = 0
                 IF ( CD-BR-ALLOT-OPTION = "Y" AND
                      BR-BP-PL = "P" )
                    OR
                    ( CD-BR-LBOX-OPTION = "Y" AND
                      BR-LBOX-PL = "P" )
                    MOVE "PAY EXCEEDS PRINCIPAL " TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

           IF BP-TRAMT > POFF-NETDUE
              IF ( (CD-BR-ALLOT-OPTION = "Y"    ) AND
                   (HOLD-BP-PAYOFF-NONCASH = "Y"  ) )
                 OR
                 ( (CD-BR-LBOX-OPTION = "Y"     ) AND
                   (HOLD-LBOX-PAYOFF-NONCASH = "Y") )
                 MOVE "99" TO HOLD-BP-TRCD
              ELSE
                 MOVE "PAY EXCEEDS PAYOFF AMT" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

           IF GP-DONT-COLL-INT-ON-SS = "Y"
              IF BP-TRCD = "SS"
                 IF BP-TRAMT > (LN-CURBAL -  .01)                  
                    MOVE "AMT > BALANCE - .01"   TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

      * TEST IF PAYMENT WILL PAYOFF LOAN PREMATURLY:
      *
      * N O T E:   THIS TEST IS NOT CORRECT, IT DOESN'T CONSIDER
      *            LN-LASTPYAMT OR PAYMENT SCHEDULES
      * 7/14/08 OK, I UNDERSTAND BP-PAYOFF-NONCASH DOESN'T ALLOW
      *         BATCH PAYOFF IF OTHER CHARGES ON ACCT, OR PAYMENT
      *         EXCEEDS PAYOFF, OR PAYOFF PRIOR TO MATURITY.
      *         DON'T GET WHY THIS FLAG IS CALL GP-PAYOFF-NONCASH.
      *         ANYWAY, WORLD ACCTS WILL BE PAID OFF EARLY WITH
      *         INSURANCE CLAIMS, SO ALLOW EARLY PAYOFF IF BATCH
      *         PMT = PAYOFF.  WORLD PR# 573.  BARB

           MOVE "N" TO PAYOFF-TRANS-FG.
           IF BP-TRAMT = POFF-NETDUE
              MOVE "Y" TO PAYOFF-TRANS-FG
              MOVE "99" TO HOLD-BP-TRCD
              GO TO SKIP-EARLY-PAYOFF-TEST.

           IF BP-TRAMT = POFF-NETDUE
              MOVE "Y" TO PAYOFF-TRANS-FG
              IF BP-TRAMT NOT = LN-REGPYAMT
                 IF ( (CD-BR-ALLOT-OPTION = "Y"    ) AND
                      (HOLD-BP-PAYOFF-NONCASH = "Y"  )
                    )
                    OR
                    ( (CD-BR-LBOX-OPTION = "Y"     ) AND
                      (HOLD-LBOX-PAYOFF-NONCASH = "Y")
                    )
                    MOVE "99" TO HOLD-BP-TRCD
                 ELSE
                    MOVE "ACCT WILL PAYOFF EARLY" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

      * WHEN BR-BP/LBOX-ALLOW-PMT-ACCT-OTHBAL = "Y"
      *      THAN ALLOW THE BATCH PAYMENT TO BE APPLIED
      *      TO THE ACCOUNT BUT NOT TO OTHER BALANCE
      *
      * 4/12/07  WE THINK THE CHECK BELOW MAKES SENSE IF THERE IS
      *          AN OTHER BAL ON THE ACCOUNT.  IF THERE IS NO OTHER
      *          BAL, THIS STOPS A PAYOFF FROM POSTING AND GIVE
      *          STUPID CUTOFF MESSAGE.   SO WE WILL ONLY DO THIS
      *          CHECK IF THERE IS AN OTHER BAL.  BARB & CINDY
      *

       SKIP-EARLY-PAYOFF-TEST.
           IF LN-OTHBAL = 0
              GO TO TEST-PAYOFF-ALLOWED.

           IF ( ( CD-BR-ALLOT-OPTION = "Y"          ) AND
                ( HOLD-BP-ALLOW-PMT-ACCT-OTHBAL = "Y" ) )
              OR
              ( ( CD-BR-LBOX-OPTION = "Y"             ) AND
                ( HOLD-LBOX-ALLOW-PMT-ACCT-OTHBAL = "Y" ) )
              IF BP-TRAMT > (VALID-POSTING-NOPOFF - LN-OTHBAL)
                 MOVE "AMT > POFF - .01 WITH OTH" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

      * TEST IF PAYOFF IS ALLOWED:

       TEST-PAYOFF-ALLOWED.
           IF ( (CD-BR-ALLOT-OPTION = "Y"  ) AND
                (BR-BP-NOPAYOFF NOT = "Y"  ) )
              OR
              ( (CD-BR-LBOX-OPTION = "Y"   ) AND
                (BR-LBOX-NOPAYOFF NOT = "Y") )
              IF BP-TRAMT = POFF-NETDUE
                 MOVE "ACCOUNT WILL PAYOFF" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

           IF ( (CD-BR-ALLOT-OPTION = "Y") AND
                (BR-BP-LC NOT = "Y"      )
              )
              OR
              ( (CD-BR-LBOX-OPTION = "Y" ) AND
                (BR-LBOX-LC NOT = "Y"    )
              )
              MOVE BP-PAYDATE TO IBPC-DATE
              PERFORM IBPC-TEST
              IF (IBPC-FG = "P" OR LN-LOANTYPE = "I")
                                        AND (LN-JDDATE = 0)
                                         AND (LN-ACCELDATE = 0)
                 MOVE BP-TRAMT     TO LCAP-TRAMT
                 MOVE BP-PAYDATE   TO LCAP-PAYDATE
                 MOVE LN-1STPYDATE TO LCAP-1STPYDATE
                 MOVE "PY"         TO LCAP-LPTRCD
                 MOVE 0            TO LCAP-LPAPLC LCAP-LPAPINT
                 MOVE CD-CODE      TO LCAP-BATCH-REFCD
                 MOVE CD-BR-LC-FG  TO LCAP-BATCH-REFCD-LC-FG
                 PERFORM LATE-CHARGE-APPLY
                 COMPUTE TEST-AMT  = LCAP-APP + LCAP-OWE - LN-LCBAL
                 IF TEST-AMT NOT = 0
                    MOVE "LATE CHARGE IS REQUIRED" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

      * TEST IF PAYMENT WILL ONLY COVER LC AND INTEREST:

           IF ( (CD-BR-ALLOT-OPTION = "Y") AND
                (BR-BP-NOPRIN NOT = "Y"  )
              )
              OR
              ( (CD-BR-LBOX-OPTION = "Y" ) AND
                (BR-LBOX-NOPRIN NOT = "Y")
              )
              COMPUTE TEST-AMT = POFF-INTDUE + POFF-LCDUE
              IF BP-TRAMT NOT > TEST-AMT
                 MOVE "PAY APPLIES WITH NO PRIN" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 GO TO MAIN-READ-BP1-NEXT.

      * TEST IF PAYMENT WILL CAUSE NEGATIVE CURRENT BALANCE:
      *
      * WHEN OT2BAL EXISTS, INSURE AT LEAST ($0.01 + LN-OT2BAL)
      * REMAINS IN LN-CURBAL:

           COMPUTE TEST-AMT = BP-TRAMT - POFF-INTDUE - POFF-LCDUE.
           IF LN-OT2BAL NOT = 0
              IF TEST-AMT >= (LN-CURBAL - TOT-POFF-REBATES)
                 IF ( (CD-BR-ALLOT-OPTION = "Y"    ) AND
                      (HOLD-BP-PAYOFF-NONCASH = "Y"  )
                    )
                    OR
                    ( (CD-BR-LBOX-OPTION = "Y"     ) AND
                      (HOLD-LBOX-PAYOFF-NONCASH = "Y")
                    )
                    MOVE "99" TO HOLD-BP-TRCD
                 ELSE
                    MOVE "PAY EXCEEDS OTHER 2 BAL." TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT
                 END-IF
              END-IF
           ELSE
      * WHEN NO OT2BAL, DON'T LET LN-CURBAL GO NEGATIVE:
              IF TEST-AMT > LN-CURBAL
                 IF ( (CD-BR-ALLOT-OPTION = "Y"    ) AND
                      (HOLD-BP-PAYOFF-NONCASH = "Y"  )
                    )
                    OR
                    ( (CD-BR-LBOX-OPTION = "Y"     ) AND
                      (HOLD-LBOX-PAYOFF-NONCASH = "Y")
                    )
                    MOVE "99" TO HOLD-BP-TRCD
                 ELSE
                    MOVE "PAY EXCEEDS CURBAL" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

      * 5/4/12:  IF THERE'S AN O2 BALANCE, IF IT'S NOT ENOUGH TO
      *          PAYOFF, BUT MORE THAN (CURBAL - O2BAL), THEN
      *          REJECT TO HANDLE MANUALLY.  FOR EXAMPLE, LN-CURBAL=70,
      *          20 OF THAT IS LN-OT2BAL.  BP-TRAMT = 50, REBATES = 15.
      *          SO TEST-AMT (50) IS LESS THAN CURBAL-REBATES (55),
      *          BUT > OR = THE BALANCE LESS O2 (50).  THE PROBLEM
      *          HERE IS THERE'S NOT ENOUGH TO PAYOFF(WOULD NEED 55),
      *          BUT WOULD NEED TO APPLY SOME OR ALL TO O2 BALANCE,
      *          AND STILL LEAVE AT LEAST 1 CENT IN BALANCE.  BETTER
      *          TO REQUIRE MANUAL POSTING.  PL 771.    BARB & CINDY

           IF LN-OT2BAL NOT = 0
              COMPUTE TEST-AMT = BP-TRAMT - POFF-INTDUE - POFF-LCDUE
              IF TEST-AMT < (LN-CURBAL - TOT-POFF-REBATES)
                 IF TEST-AMT >= (LN-CURBAL - LN-OT2BAL)
                    MOVE "REQUIRES MANUAL Z2" TO D-EXCEPT
                    PERFORM MAIN-EXCEPTION
                    GO TO MAIN-READ-BP1-NEXT.

       SKIP-PAYOFF-CALC.

      * DON'T ALLOW POSTING WHEN LOAN HAS ZERO BALANCE

           IF LN-CURBAL = 0
              MOVE "ALREADY ZERO BALANCE" TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              GO TO MAIN-READ-BP1-NEXT.

      * TEST FOR VALID GENERAL LEDGER INTERFACE RECORD:

           MOVE LN-OWNBR TO GI-BRANCH.
           MOVE LN-CLASS TO GI-CLASS.
           PERFORM READ-GI1-FILE.
           IF IO-FG NOT = 0
              MOVE "MISSING G/L INTERFACE " TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              GO TO MAIN-READ-BP1-NEXT.

           MOVE " " TO POSTING-ERRCD
                       D-EXCEPT.

           IF CD-BR-FILE-TYPE = "B"
              PERFORM BANKRUPT-POSTING
           ELSE
           IF BP-TRCD = "RV"
              PERFORM REVERSAL-POSTING
           ELSE
              IF (BP-TRAMT > VALID-POSTING-NOPOFF) AND
                 (HOLD-BP-TRCD = "99"            )
                 PERFORM PAYOFF-POSTING
              ELSE
                 PERFORM PAYMENT-POSTING.

           IF NOT (POSTING-ERRCD = " " OR "O")
              GO TO MAIN-READ-BP1-NEXT.

           PERFORM CLEAR-LEGEND.

           ADD ORIG-BP-TRAMT TO AMOUNT-POSTED(1) AMOUNT-POSTED(2).
           ADD 1             TO TOTAL-POSTED(1)  TOTAL-POSTED(2).


           MOVE "U" TO BP-UPDFG.
           PERFORM REWRITE-BP1-FILE.

           MOVE "N" TO FIRST-TIME.
           GO TO MAIN-READ-BP1-NEXT.


       END-OF-GROUP.
           MOVE 1 TO LEV.
           PERFORM PRINT-TOTALS
           PERFORM SET-BRANCH-HEADINGS.
           PERFORM CLOSE-BP1-FILE.
           PERFORM CLOSE-OP-FILE.

      * REMOVE THE BP FILE HERE FOR NORMAL EXITS
           MOVE BP-PATH TO ACCESS-BUF.
           PERFORM REMOVE-WORKFILE.

           GO TO NEXT-GROUP-LOC.

       END-ROUTINE.
           MOVE 2 TO LEV.
           PERFORM PRINT-TOTALS.
           PERFORM SET-BRANCH-HEADINGS.
           PERFORM RESTORE-SCREEN.
           PERFORM CLOSE-BP1-FILE.
           PERFORM CLOSE-OP-FILE.

      * REMOVE THE BP FILE HERE FOR NORMAL EXITS
           MOVE BP-PATH TO ACCESS-BUF.
           PERFORM REMOVE-WORKFILE.
           PERFORM MOVE-BTFILE.

           MOVE 0 TO BATCH.
           GO TO END-PROGRAM.

      ************************************
      * VALIDATE REVERSAL ROUTINE        *
      ************************************
       VALIDATE-REVERSAL SECTION.
           MOVE "Y" TO VALID-REVERSAL-FG.

           PERFORM OPEN-LP1-FILE.

           MOVE LP-PATH-OWNBR TO LP-BRNO
                                 QLP1-WBEG-BRNO
                                 QLP1-WEND-BRNO
           MOVE LN-ACCTNO     TO LP-ACCTNO
                                 QLP1-WBEG-ACCTNO
                                 QLP1-WEND-ACCTNO.
           MOVE ALL "9"       TO LP-SEQNO
                                 QLP1-WEND-SEQNO.
           MOVE ALL "0"       TO QLP1-WBEG-SEQNO.

           PERFORM START-LP1-FILE-NOT-GREATER.
           PERFORM READ-LP1-FILE-PREVIOUS.
           IF (IO-FG NOT = 0) OR (LP-ACCTNO NOT = LN-ACCTNO)
              GO TO INVALID-REVERSAL.

           IF LP-TRCD = "RV" OR LP-REV = "Y"
              GO TO INVALID-REVERSAL.

           IF LP-TRCD NOT = "PA"
              GO TO INVALID-REVERSAL.

           IF LP-PAYDATE NOT = BP-PAYDATE
              OR LP-TRAMT NOT = BP-TRAMT
                 OR LP-REFNO NOT = BP-REFCD
                    GO TO INVALID-REVERSAL.

           MOVE 0      TO LP-TILLNO.

           MOVE LP-REC TO WK-LP-REC.

           GO TO EXIT-VALIDATE-REVERSAL.
       INVALID-REVERSAL.
           MOVE "N" TO VALID-REVERSAL-FG.
           MOVE "NO VALID PMT FOR REVERSAL" TO D-EXCEPT.
           IF LP-PAYDATE NOT = BP-PAYDATE
              MOVE "NO REVERSE: NO DATE MATCH" TO D-EXCEPT.
           IF LP-TRAMT NOT = BP-TRAMT
              MOVE "NO REVERSE: NO AMT MATCH"  TO D-EXCEPT.
           IF LP-REFNO NOT = BP-REFCD
              MOVE "NO REVERSE:NO REFNO MATCH" TO D-EXCEPT.
           IF LP-TRCD = "RV" OR LP-REV = "Y"
              MOVE "NO REVERSE:LAST PMT IS RV" TO D-EXCEPT.
           IF LP-TRCD NOT = "PA"
             MOVE "NO REVERSE: NOT A 'PA'   " TO D-EXCEPT.
           PERFORM MAIN-EXCEPTION.
       EXIT-VALIDATE-REVERSAL.
           PERFORM CLOSE-LP1-FILE.

      ******************************************************************
       PAYMENT-POSTING SECTION.
      ******************************************************************

      * RESTORE LOAN TO ITS ORIG STATE ELSE WILL ERROR OUT OF LONPF2
      * (LN-REC == WK-SAVE-REC)

           MOVE ORIG-LN-LBOX    TO LN-LBOX.
           MOVE ORIG-LN-ALLOTCD TO LN-ALLOTCD.

      * SETUP-LP-RECORD
           PERFORM SETUP-LP-RECORD.
           MOVE BP-TRAMT TO LP-TRAMT.

      * SETUP-LONPF-BUFFER
           MOVE 0 TO HOLD-OVPAID-CHECK.

           IF PAYOFF-TRANS-FG = "Y"
              MOVE "PO" TO HOLD-POCD.

      * AUTOMATIC BATCH TRCD = "PA" FROM BPBKBR.C
      * MANUAL BATCH MAY BE "PA" OR "PY"

           IF HOLD-BP-TRCD = " "
              MOVE BP-TRCD TO HOLD-BP-TRCD LP-TRCD
           ELSE
              MOVE "PA" TO LP-TRCD.

           PERFORM SETUP-LONPF-BUFFER.

      * PAYMENT POSTING

           IF (HOLD-BP-TRCD = "RE" OR "O2")
              MOVE "LP/LONPF7" TO FORM-NAM
           ELSE
           IF HOLD-BP-TRCD = "RP"
              MOVE "LP/LONPFB" TO FORM-NAM
           ELSE
           IF (HOLD-BP-TRCD = "PL" OR "P2" OR "P3")
              MOVE "LP/LONPF9" TO FORM-NAM
           ELSE
              MOVE "LP/LONPFC" TO FORM-NAM.

           MOVE FORM-PROGX TO PAYMENT-PROG.
           CALL FORM-PROGX USING FORM-PATH EXIT-PATHNAME
                                PROG-BUF  UPDATE-BUF.
           CANCEL FORM-PROGX.

      * TEST PROG-BUF (ERRCD) TO MAKE SURE LONPFC DID NOT REJECT
      * THE PROPOSED TRANSACTION

           IF ERRCD = "P"
              IF PAYMENT-PROG = "LONPFC"
                 MOVE "LONPFC: ALT PREPAYMENT    " TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 MOVE "E" TO POSTING-ERRCD
                 GO TO PAYMENT-POSTING-EXIT.
           
           IF PAYMENT-PROG = "LONPFB"
              IF NOT (ERRCD = " " OR "P")
                 MOVE "######: PMT NOT APPLIED:&" TO D-EXCEPT
                 INSPECT D-EXCEPT REPLACING FIRST "######"
                                            BY PAYMENT-PROG
                 INSPECT D-EXCEPT REPLACING FIRST "&"
                                            BY ERRCD
                 PERFORM MAIN-EXCEPTION
                 MOVE "E" TO POSTING-ERRCD
                 GO TO PAYMENT-POSTING-EXIT
              END-IF
           ELSE
              IF ERRCD NOT = " "
                 MOVE "######: PMT NOT APPLIED:& " TO D-EXCEPT
                 INSPECT D-EXCEPT REPLACING FIRST "######"
                                            BY PAYMENT-PROG
                 INSPECT D-EXCEPT REPLACING FIRST "&"
                                            BY ERRCD
                 PERFORM MAIN-EXCEPTION
                 MOVE "E" TO POSTING-ERRCD
                 GO TO PAYMENT-POSTING-EXIT.

      * PAYMENT UPDATE

           MOVE 0 TO HOLD-PRIOR-DF-POSTDATE.

           MOVE "LP/LONPF2" TO FORM-NAM.
           CALL FORM-PROGX USING FORM-PATH EXIT-PATHNAME
                                PROG-BUF UPDATE-BUF.
           CANCEL FORM-PROGX.

      * TEST PROG-BUF (ERRCD) TO MAKE SURE LONPF2 DID NOT REJECT
      * THE PROPOSED TRANSACTION

           IF ERRCD = "E" OR "X" OR "M"
              MOVE "LONPF2: PMT NOT APPLIED  " TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              MOVE "E" TO POSTING-ERRCD
              GO TO PAYMENT-POSTING-EXIT.


       PAYMENT-POSTING-EXIT.
           EXIT.

      ******************************************************************
       PAYOFF-POSTING SECTION.
      ******************************************************************

      * RESTORE LOAN TO ITS ORIG STATE ELSE WILL ERROR OUT
      * OF LONPF2 (LN-REC == WK-SAVE-REC)

           MOVE ORIG-LN-LBOX    TO LN-LBOX.
           MOVE ORIG-LN-ALLOTCD TO LN-ALLOTCD.
           MOVE 0               TO HOLD-OVPAID-CHECK.

      * NO O2 MONIES

           IF LN-OT2BAL = 0
              IF ( (CD-BR-ALLOT-OPTION = "Y"      ) AND
                   (BR-BP-PAYOFF-OV = "O" OR "M"  )
                 )
                 OR
                 ( (CD-BR-LBOX-OPTION = "Y"       ) AND
                   (BR-LBOX-PAYOFF-OV = "O" OR "M")
                 )
                 SUBTRACT WILL-POFF-ACCOUNT FROM BP-TRAMT
                                      GIVING HOLD-OVPAID-CHECK
                                             OVPAID-AMT
                 IF OVPAID-AMT NOT = 0
                    ADD OVPAID-AMT TO AMOUNT-OVPAID(1)
                                      AMOUNT-OVPAID(2)
                    ADD 1          TO TOTAL-OVPAID(1)
                                      TOTAL-OVPAID(2)
                    MOVE " "            TO D-EXCEPT
                    MOVE "OVER PAID = " TO D-OVEX
                    MOVE OVPAID-AMT     TO D-OVPY
                    PERFORM MAIN-EXCEPTION
                 END-IF
                 MOVE WILL-POFF-ACCOUNT TO BP-TRAMT
                 PERFORM POST-PO
                 IF POSTING-ERRCD NOT = " "
                    GO TO PAYOFF-POSTING-EXIT
                 END-IF
              ELSE
                 MOVE 0 TO HOLD-OVPAID-CHECK
                 SUBTRACT WILL-POFF-ACCOUNT FROM BP-TRAMT
                                        GIVING OVPAID-AMT
                 IF OVPAID-AMT NOT = 0
                    ADD OVPAID-AMT TO AMOUNT-OVPAID(1)
                                      AMOUNT-OVPAID(2)
                    ADD 1          TO TOTAL-OVPAID(1)
                                      TOTAL-OVPAID(2)
                 END-IF
                 MOVE WILL-POFF-ACCOUNT TO BP-TRAMT
                 IF BP-TRAMT NOT = 0
                    PERFORM POST-PO
                    IF POSTING-ERRCD NOT = " "
                       GO TO PAYOFF-POSTING-EXIT
                    END-IF
                 END-IF
                 MOVE " "            TO D-EXCEPT
                 IF OVPAID-AMT NOT = 0
                    MOVE "OVER PAID = " TO D-OVEX
                    MOVE OVPAID-AMT     TO D-OVPY
                    MOVE "O" TO POSTING-ERRCD
                    PERFORM MAIN-EXCEPTION
                 END-IF
              END-IF
           ELSE
      * O2 MONIES EXIST SO EITHER PAYOFF OR REFUND LEAVING $0.01 IN PRIN
              PERFORM POST-Z2
              IF POSTING-ERRCD NOT = " "
                 GO TO PAYOFF-POSTING-EXIT
              END-IF
              SUBTRACT TEST-AMT FROM BP-TRAMT
              PERFORM READ-LN1-FILE
              IF IO-FG NOT = 0
                 MOVE "Y" TO NOT-ON-FILE-FG
                 MOVE "AFTER Z2, LOAN MISSING" TO D-EXCEPT
                 PERFORM MAIN-EXCEPTION
                 MOVE "E" TO POSTING-ERRCD
                 GO TO PAYOFF-POSTING-EXIT
              END-IF
              IF ( (CD-BR-ALLOT-OPTION = "Y"      ) AND
                   (BR-BP-PAYOFF-OV = "O" OR "M"  )
                 )
                 OR
                 ( (CD-BR-LBOX-OPTION = "Y"       ) AND
                   (BR-LBOX-PAYOFF-OV = "O" OR "M")
                 )
                 IF WILL-POFF-ACCOUNT >= BP-TRAMT
                    MOVE 0 TO HOLD-OVPAID-CHECK
                              OVPAID-AMT
      * REFUNDS + "PY"
                    IF BP-TRAMT > 0
                       PERFORM POST-REFUNDS-PLUS-PY
                    END-IF
                    GO TO PAYOFF-POSTING-EXIT
                 ELSE
                    SUBTRACT WILL-POFF-ACCOUNT FROM BP-TRAMT
                                      GIVING HOLD-OVPAID-CHECK
                                             OVPAID-AMT
                    ADD OVPAID-AMT      TO AMOUNT-OVPAID(1)
                                           AMOUNT-OVPAID(2)
                    ADD 1               TO TOTAL-OVPAID(1)
                                           TOTAL-OVPAID(2)
                    MOVE " "            TO D-EXCEPT
                    MOVE "OVER PAID = " TO D-OVEX
                    MOVE OVPAID-AMT     TO D-OVPY
                    PERFORM MAIN-EXCEPTION
                 END-IF
                 PERFORM POST-PO
                 IF POSTING-ERRCD NOT = " "
                    GO TO PAYOFF-POSTING-EXIT
                 END-IF
              ELSE
                 MOVE 0 TO HOLD-OVPAID-CHECK
                 IF WILL-POFF-ACCOUNT >= BP-TRAMT
                    MOVE 0 TO OVPAID-AMT
      * REFUNDS + "PY"
                    IF BP-TRAMT > 0
                       PERFORM POST-REFUNDS-PLUS-PY
                    END-IF
                    GO TO PAYOFF-POSTING-EXIT
                 ELSE
                    SUBTRACT WILL-POFF-ACCOUNT FROM BP-TRAMT
                                        GIVING OVPAID-AMT
                    IF OVPAID-AMT NOT = 0
                       ADD OVPAID-AMT      TO AMOUNT-OVPAID(1)
                                              AMOUNT-OVPAID(2)
                       ADD 1               TO TOTAL-OVPAID(1)
                                              TOTAL-OVPAID(2)
                       MOVE " "            TO D-EXCEPT
                       MOVE "OVER PAID = " TO D-OVEX
                       MOVE OVPAID-AMT     TO D-OVPY
                       PERFORM MAIN-EXCEPTION
                    END-IF
                 END-IF
                 PERFORM POST-PO
              END-IF.


       PAYOFF-POSTING-EXIT.
           EXIT.

      *********************************************************
       POST-PO SECTION.
      *********************************************************

      * SETUP-LP-RECORD

           PERFORM SETUP-LP-RECORD.
           MOVE BP-TRAMT TO LP-TRAMT.
           MOVE "PO"     TO LP-TRCD.

      * SETUP-LONPF-BUFFER

           MOVE "PO" TO HOLD-POCD.

           MOVE "99" TO HOLD-BP-TRCD.


           PERFORM SETUP-LONPF-BUFFER.

      * PAYOFF POSTING
           MOVE "LP/LONPFA" TO FORM-NAM.

           CALL FORM-PROGX USING FORM-PATH EXIT-PATHNAME
                                PROG-BUF UPDATE-BUF.
           CANCEL FORM-PROGX.

      * TEST PROG-BUF (ERRCD) TO MAKE SURE LONPFC DID NOT REJECT
      * THE PROPOSED TRANSACTION

           IF ERRCD NOT = " "
              MOVE "LONPFC: PMT NOT APPLIED   " TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              MOVE "E" TO POSTING-ERRCD
              GO TO POST-PO-EXIT.

      * PAYOFF UPDATE

           MOVE "LP/LONPF2" TO FORM-NAM.
           CALL FORM-PROGX USING FORM-PATH EXIT-PATHNAME
                                PROG-BUF  UPDATE-BUF.
           CANCEL FORM-PROGX.

      * TEST PROG-BUF (ERRCD) TO MAKE SURE LONPF2 DID NOT REJECT
      * THE PROPOSED TRANSACTION

           IF ERRCD = "E" OR "X" OR "M"
              MOVE "LONPF2: PMT NOT APPLIED  " TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              MOVE "E" TO POSTING-ERRCD
              GO TO POST-PO-EXIT.

       POST-PO-EXIT.
           EXIT.

      *********************************************************
       POST-Z2 SECTION.
      *********************************************************

      * SETUP-LP-RECORD

           PERFORM SETUP-LP-RECORD.

           MOVE "Z2" TO LP-TRCD.

      * ASSURE THAT $0.01 REMAININGS IN PRINCIPAL
           IF LN-OT2BAL > (BP-TRAMT - VALID-POSTING-NOPOFF)
              COMPUTE TEST-AMT
                      LP-TRAMT
                      LP-APOT2 = BP-TRAMT - VALID-POSTING-NOPOFF
           ELSE
              MOVE LN-OT2BAL TO TEST-AMT
                                LP-TRAMT
                                LP-APOT2.

      * SETUP-LONPF-BUFFER
           MOVE " "  TO HOLD-POCD.
           MOVE "Z2" TO HOLD-BP-TRCD.

           PERFORM SETUP-LONPF-BUFFER.

      * Z2 POSTING
           MOVE "LP/LONPFC" TO FORM-NAM.

           CALL FORM-PROGX USING FORM-PATH EXIT-PATHNAME PROG-BUF
                                           UPDATE-BUF.
           CANCEL FORM-PROGX.

      * TEST PROG-BUF (ERRCD) TO MAKE SURE LONPFC DID NOT REJECT
      * THE PROPOSED TRANSACTION

           IF ERRCD NOT = " "
              MOVE "LONPFC: PMT NOT APPLIED   " TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              MOVE "E" TO POSTING-ERRCD
              GO TO POST-Z2-EXIT.

      * Z2 UPDATE

           MOVE "LP/LONPF2" TO FORM-NAM.
           CALL FORM-PROGX USING FORM-PATH EXIT-PATHNAME
                                PROG-BUF UPDATE-BUF.
           CANCEL FORM-PROGX.

      * TEST PROG-BUF (ERRCD) TO MAKE SURE LONPF2 DID NOT REJECT
      * THE PROPOSED TRANSACTION

           IF ERRCD = "E" OR "X" OR "M"
              MOVE "LONPF2: PMT NOT APPLIED  " TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              MOVE "E" TO POSTING-ERRCD
              GO TO POST-Z2-EXIT.

       POST-Z2-EXIT.
           EXIT.

      *********************************************************
       POST-REFUNDS-PLUS-PY SECTION.
      *********************************************************

           MOVE 0 TO SUB1.
       POST-REFUNDS-PLUS-PY-AGAIN.
           ADD 1 TO SUB1.
           IF SUB1 > 13
              GO TO POST-REFUNDS-PLUS-PY-NOW.

           IF SUB1 = 1
              IF POFF-REBATE(1) NOT = 0
                 MOVE "RC" TO HOLD-BP-TRCD
              ELSE
                 IF LN-INSPREM(SUB1) NOT = 0 AND
                    LN-REBATE(SUB1) = " "
                    MOVE "RC" TO HOLD-BP-TRCD
                 ELSE
                    GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 2
              IF POFF-REBATE(2) NOT = 0
                 MOVE "RA" TO HOLD-BP-TRCD
              ELSE
                 IF LN-INSPREM(SUB1) NOT = 0 AND
                    LN-REBATE(SUB1) = " "
                    MOVE "RA" TO HOLD-BP-TRCD
                 ELSE
                    GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 3
              IF POFF-REBATE(3) NOT = 0
                 MOVE "RP" TO HOLD-BP-TRCD
              ELSE
                 IF LN-INSPREM(SUB1) NOT = 0 AND
                    LN-REBATE(SUB1) = " "
                    MOVE "RP" TO HOLD-BP-TRCD
                 ELSE
                    GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 4
              IF POFF-REBATE(4) NOT = 0
                 MOVE "RI" TO HOLD-BP-TRCD
              ELSE
                 GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 5
              IF POFF-REBATE(5) NOT = 0
                 MOVE "RS" TO HOLD-BP-TRCD
              ELSE
                 GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 6
              IF POFF-REBATE(6) NOT = 0
                 MOVE "RM" TO HOLD-BP-TRCD
              ELSE
                 GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 7
              IF POFF-REBATE(7) NOT = 0
                 MOVE "RD" TO HOLD-BP-TRCD
              ELSE
                 GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 8
              GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 9
              IF POFF-REBATE(9) NOT = 0
                 MOVE "R1" TO HOLD-BP-TRCD
              ELSE
                 IF LN-INSPREM(SUB1 - 5) NOT = 0 AND
                    LN-REBATE(SUB1) = " "
                    MOVE "R1" TO HOLD-BP-TRCD
                 ELSE
                    GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 10
              IF POFF-REBATE(10) NOT = 0
                 MOVE "R2" TO HOLD-BP-TRCD
              ELSE
                 IF LN-INSPREM(SUB1 - 5) NOT = 0 AND
                    LN-REBATE(SUB1) = " "
                    MOVE "R2" TO HOLD-BP-TRCD
                 ELSE
                    GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 11
              IF POFF-REBATE(11) NOT = 0
                 MOVE "R3" TO HOLD-BP-TRCD
              ELSE
                 IF LN-INSPREM(SUB1 - 5) NOT = 0 AND
                    LN-REBATE(SUB1) = " "
                    MOVE "R3" TO HOLD-BP-TRCD
                 ELSE
                    GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 12
              IF POFF-REBATE(12) NOT = 0
                 MOVE "R4" TO HOLD-BP-TRCD
              ELSE
                 IF LN-INSPREM(SUB1 - 5) NOT = 0 AND
                    LN-REBATE(SUB1) = " "
                    MOVE "R4" TO HOLD-BP-TRCD
                 ELSE
                 GO TO POST-REFUNDS-PLUS-PY-AGAIN.
           IF SUB1 = 13
              IF POFF-REBATE(13) NOT = 0
                 MOVE "R5" TO HOLD-BP-TRCD
              ELSE
                 IF LN-INSPREM(SUB1 - 5) NOT = 0 AND
                    LN-REBATE(SUB1) = " "
                    MOVE "R5" TO HOLD-BP-TRCD
                 ELSE
                    GO TO POST-REFUNDS-PLUS-PY-AGAIN.

      * SETUP-LP-RECORD
           MOVE " " TO ERRCD.
           PERFORM SETUP-LP-RECORD.
           MOVE POFF-REBATE(SUB1) TO LP-TRAMT LP-APCUR.
           MOVE HOLD-BP-TRCD      TO LP-TRCD.

      * SETUP LONPF BUFFER

      * THIS SET OF 'F9' TRIGGERS LONPFB.C TO DO A REFUND OF INTEREST
      * WITH "PO" IN REB-LPTRCD, LIKE CRNOR2.C

           IF HOLD-BP-TRCD = "RI"
              MOVE "F9" TO HOLD-BP-TRCD.

           PERFORM SETUP-LONPF-BUFFER.


           MOVE "LP/LONPFB" TO FORM-NAM.
           CALL FORM-PROGX USING FORM-PATH EXIT-PATHNAME PROG-BUF
                                          UPDATE-BUF.
           CANCEL FORM-PROGX.

      * TEST PROG-BUF (ERRCD) TO MAKE SURE LONPFB DID NOT REJECT
      * THE PROPOSED TRANSACTION

           IF ERRCD NOT = " "
              MOVE "LONPFB: REFUND NOT APPLIED" TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              MOVE "E" TO POSTING-ERRCD
              GO TO POST-REFUNDS-PLUS-PY-EXIT.

      * UPDATE PROGRAM

           MOVE "LP/LONPF2" TO FORM-NAM.
           CALL FORM-PROGX USING FORM-PATH EXIT-PATHNAME
                                PROG-BUF UPDATE-BUF.
           CANCEL FORM-PROGX.

      * TEST PROG-BUF (ERRCD) TO MAKE SURE LONPF2 DID NOT REJECT
      * THE PROPOSED TRANSACTION

           IF ERRCD = "E" OR "X" OR "M"
              MOVE "LONPF2: REFUND NOT UPDATED" TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              MOVE "E" TO POSTING-ERRCD
              GO TO POST-REFUNDS-PLUS-PY-EXIT.

      * READ UPDATED LOAN
           PERFORM READ-LN1-FILE.

           GO TO POST-REFUNDS-PLUS-PY-AGAIN.

       POST-REFUNDS-PLUS-PY-NOW.

      * READ UPDATED LOAN (ONE MORE TIME, IN CASE THERE WERE NO REBATES)

           PERFORM READ-LN1-FILE.

      * MUST SET TO " " TO GET DEFAULT BP-TRCD SET:
           MOVE " " TO HOLD-BP-TRCD.

      * MERCURY RE:256X
      * MUST SET ORIG-LN-.... TO LN-..... VALUES SINCE THEY HAVE
      * CHANGED WHEN LONPF2.C WAS CALLED ABOVE AND PAYMENT-POSTING
      * ROUTINE SET THEM TO THE ORIGINAL VALUES WHEN THE LOAN WAS
      * FIRST PROCESSED.

           MOVE LN-LBOX    TO ORIG-LN-LBOX.
           MOVE LN-ALLOTCD TO ORIG-LN-ALLOTCD.

           PERFORM PAYMENT-POSTING.

           MOVE WK-LP-REC TO LP-REC.

       POST-REFUNDS-PLUS-PY-EXIT.
           EXIT.

      ******************************************************************
       BANKRUPT-POSTING SECTION.
      ******************************************************************

      * RESTORE LOAN TO ITS ORIG STATE ELSE WILL ERROR OUT OF LONPF2
      * (LN-REC == WK-SAVE-REC)

           MOVE ORIG-LN-LBOX    TO LN-LBOX.
           MOVE ORIG-LN-ALLOTCD TO LN-ALLOTCD.

           PERFORM SETUP-LP-RECORD.

           MOVE BP-TRAMT TO LP-TRAMT.
           MOVE BP-BNKRPT-CASE-NO TO HOLD-BNKRPT-CASE-NO.
           MOVE BP-BNKRPT-STATUS  TO HOLD-BNKRPT-STATUS.
           MOVE LN-OTHBAL TO LP-OTHBAL.
           MOVE LN-OT2BAL TO LP-OT2BAL.
           MOVE LN-INTBAL TO LP-INTBAL.
           MOVE LN-LCBAL TO LP-LCBAL.
           MOVE LN-CURBAL TO LP-CURBAL.
           MOVE LP-PAYDATE TO IBPC-DATE.
           PERFORM IBPC-TEST.
           MOVE IBPC-FG TO LP-IBPC.
           MOVE LN-CURBAL TO LP-INTDUE.
           MOVE LN-1STPYDATE TO PDTH-DATE-WORK.
           PERFORM PAID-THRU-CALCULATION.
           MOVE PDTH-DATE-FULL TO LP-PDTH-DATE.
           ADD LP-APLC TO HOLD-LN-TOTERN HOLD-LN-TOTLCHG.
           ADD LP-APINT TO HOLD-LN-TOTERN HOLD-LN-TOTINT.

      * SETUP-LONPF-BUFFER
           MOVE 0 TO HOLD-OVPAID-CHECK.

      * AUTOMATIC BATCH TRCD = "PA" FROM BPBKBR.C
      * MANUAL BATCH MAY BE "PA" OR "PY"

           MOVE BP-TRCD TO HOLD-BP-TRCD LP-TRCD.

           PERFORM SETUP-LONPF-BUFFER.

      * PAYMENT UPDATE

           MOVE "LP/LONPF2" TO FORM-NAM.
           CALL FORM-PROGX USING FORM-PATH EXIT-PATHNAME
                                PROG-BUF UPDATE-BUF.
           CANCEL FORM-PROGX.

      * TEST PROG-BUF (ERRCD) TO MAKE SURE LONPF2 DID NOT REJECT
      * THE PROPOSED TRANSACTION

           IF ERRCD = "E" OR "X" OR "M"
              MOVE "LONPF2: PMT NOT APPLIED  " TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              MOVE "E" TO POSTING-ERRCD
              GO TO PAYMENT-POSTING-EXIT.

       BANKRUPT-POSTING-EXIT.
           EXIT.

      ******************************************************************
      *     REVERSAL POSTING
      ******************************************************************
       REVERSAL-POSTING SECTION.

      ******************************************************************
      * SOME LOGIC FROM SETUP-LONPF-BUFFER:
      ******************************************************************

           MOVE 0   TO ENTRY-FLAG BYPASS-AMT-ENT-FG.
           MOVE "F" TO FULL-DISPLAY.
           MOVE " " TO REV-REBATE FULL-PAGE-FG ENTER-AMT-FG
                       HOLD-DISPLAY-ERN
                       HOLD1-KEY-DOWN HOLD2-KEY-UP.

           MOVE LN-ORGST    TO SP-ORGST.
           MOVE LN-SPRCLASS TO SP-SPRCLASS.
           MOVE LN-SUBCLASS TO SP-SUBCLASS.
           MOVE LN-LAWCODE  TO SP-LAWCODE.

           MOVE 0 TO HOLD-PARTIALS
                     HOLD-LCPAID
                     HOLD-DLPARVHELD-ADJ
                     HOLD-AFPDLLP
                     HOLD-OVPAID-CHECK
                     HOLD-REPO-AUCTION-EXP
                     ADDON-INT-REBATE
                     ADDON-INT-EARNED
                     HOLD-PRIOR-DF-POSTDATE.

           MOVE LN-TOTINT     TO HOLD-LN-TOTINT.
           MOVE LN-TOTERN     TO HOLD-LN-TOTERN.
           MOVE LN-TOTDEF     TO HOLD-LN-TOTDFMNTS.
           MOVE LN-TOTLCHG    TO HOLD-LN-TOTLCHG.
           MOVE LN-TOTSERACCT TO HOLD-LN-TOTSERACCT.
           MOVE LN-JDRATE     TO HOLD-LN-JDRATE.

           PERFORM VARYING SUB FROM 1 BY 1 UNTIL SUB > 13
              MOVE 0 TO REB-AMOUNT(SUB)
              IF SUB < 7
                 MOVE LN-ACCERN(SUB) TO HOLD-LN-ACCERN(SUB)
              END-IF
              IF SUB < 9
                 MOVE " " TO INS-RB-TBL(SUB)
              END-IF
           END-PERFORM.

      ******************************************************************
      *    RESTORE LOAN TO ITS ORIG STATE ELSE WILL ERROR OUT
      *    OF LONPF2 (LN-REC == WK-SAVE-REC)
      ******************************************************************
           MOVE ORIG-LN-LBOX    TO LN-LBOX.
           MOVE ORIG-LN-ALLOTCD TO LN-ALLOTCD.

           MOVE LX-REC  TO WK-LX-REC.
           MOVE LXE-REC TO WK-LXE-REC.
           MOVE LXG-REC TO WK-LXG-REC.
           PERFORM CLOSE-LP1-FILE.

           PERFORM READ-EARNINGS.

      * GET THE GL FOR THIS REVERSAL
           PERFORM OPEN-LXG1-FILE.
           MOVE LP-BRNO   TO LXG-BRNO.
           MOVE LP-ACCTNO TO LXG-ACCTNO.
           MOVE LP-SEQNO  TO LXG-SEQNO.
           PERFORM READ-LXG1-FILE.
           PERFORM CLOSE-LXG1-FILE.
           IF IO-FG NOT = 0
              MOVE 0 TO LXG-GLNO(1)  LXG-GLNO(2)  LXG-GLNO(3)
                        LXG-GLAMT(1) LXG-GLAMT(2) LXG-GLAMT(3).

       REVERSAL-LP1-FILE.
           MOVE LP-TRCD  TO REV-TRCD.
           MOVE LP-REFNO TO REV-REFNO.

           ADD LN-INTBAL LP-APINT GIVING LP-INTBAL.
           ADD LN-OTHBAL LP-APOTH GIVING LP-OTHBAL.
           ADD LN-LCBAL LP-APLC GIVING LP-LCBAL.

           MOVE LN-CURBAL TO LP-CURBAL.

      * "OTWOAPJDPLPIPWRPTSTPSPBKBD" (NOT).
      *  PA NOT IN LIST SO WILL BE CDV-NO-MATCH
           MOVE CDV-17 TO CDV-BUF.
           PERFORM CDV-VERIFY.

      * THE "DF" HAS THE AMOUNT IN INTDUE SO INTBAL COMES OUT RIGHT:
           IF (CDV-NO-MATCH OR (REV-TRCD = "Z2"))
              IF ( REV-TRCD NOT = "WL" ) AND
                 ( SP-CAL-RATETYPE(1) NOT = "Z" ) AND
                 ( NOT (REV-TRCD = "RE" AND LN-LOANTYPE = "I") )
                   SUBTRACT LP-INTDUE FROM LP-INTBAL.

      * ADDON-POSTING, LP-APINTOWE HOLDS LN-INTPDTH BEFORE ADDON:
           IF (CDV-NO-MATCH OR (REV-TRCD = "Z2"))
              IF NOT ADDON-POSTING
                 SUBTRACT LP-APINTOWE FROM LP-LCBAL.

           MULTIPLY -1 BY
              LP-TRAMT LP-APOTH LP-APINT LP-APLC LP-APCUR
              LP-INTDUE LP-DLPROC LP-EARNED(1) LP-EARNED(2)
              LP-EARNED(3) LXG-GLAMT(1) LXG-GLAMT(2) LXG-GLAMT(3)
              LP-INTPAID LXE-EARN(1) LXE-EARN(2) LXE-EARN(3)
              LXE-EARN(4) LXE-EARN(5) LXE-EARN(6) LXE-EARN(7)
              LXE-WORKER LXE-WORKER2 LP-NOLCHG LP-PREPAY-PENALTY
              LP-PRORATED-INS-REB LP-EXTRA-PRIN-LFP LP-APPLIED-TO-ESCROW.

      * ADDON-POSTING, LP-APINTOWE HOLDS LN-INTPDTH BEFORE ADDON
           IF REV-TRCD NOT = "SP" AND NOT = "DC" AND
                        NOT ADDON-POSTING
              MULTIPLY -1 BY LP-APINTOWE.

           IF REB-AMOUNT(1) NOT = 0
              IF LN-ADDON-FG = "Y"
                 ADD LN-ANTICADJ(1) REB-AMOUNT(1)
                                         GIVING ADDON-INT-REBATE.

      * FOR PC ACCOUNTS, 'RI' MAY HAVE A VALUE:
           MOVE SPACES TO HOLD-DL-RVCHGS-CODE(1)
                          HOLD-DL-RVCHGS-CODE(2)
                          HOLD-DL-RVCHGS-CODE(3)
                          HOLD-DL-PARVHELD-CODE
                          HOLD-DL-PARVPAID-CODE.

           IF LN-SERVACCT NOT = "Y"
              PERFORM CALC-HOLD-LN-ACCERN.

           COMPUTE HOLD-LN-TOTERN =
                LN-TOTERN
                    + LP-EARNED(1) + LP-EARNED(2) + LP-EARNED(3)
                     + LXE-EARN(1) + LXE-EARN(2)  + LXE-EARN(3)
                     + LXE-EARN(4) + LXE-EARN(5)  + LXE-EARN(6)
                     + LXE-EARN(7).

           IF LN-SERVACCT NOT = "Y"
              IF NOT ADDON-POSTING
                  IF REV-TRCD NOT = "WI" AND NOT = "WL"
                     IF REV-TRCD NOT = "RD"
                        ADD LP-APINT LP-APLC TO HOLD-LN-TOTERN
                     ELSE
                        SUBTRACT LP-TRAMT FROM HOLD-LN-TOTERN.

           MOVE LN-TOTDEF TO HOLD-LN-TOTDFMNTS.
           IF DF-POSTING
              IF SP-DEFFRMLA = 97 OR 96 OR 95
                 COMPUTE HOLD-LN-TOTINT = LN-TOTINT + LP-APINT
              ELSE
                 COMPUTE HOLD-LN-TOTDFMNTS = LN-TOTDEF + LP-APINT
              END-IF
           ELSE
              IF REV-TRCD = "RD"
                 COMPUTE HOLD-LN-TOTDFMNTS = LN-TOTDEF - LP-TRAMT
              ELSE
                 IF REB-AMOUNT(7) NOT = 0
                   COMPUTE HOLD-LN-TOTDFMNTS = LN-TOTDEF - REB-AMOUNT(7)
                   SUBTRACT REB-AMOUNT(7) FROM HOLD-LN-TOTERN.

           IF NOT (DF-POSTING AND (SP-DEFFRMLA = 97 OR 96 OR 95))
              MOVE LN-TOTINT TO HOLD-LN-TOTINT.
           MOVE LN-TOTLCHG TO HOLD-LN-TOTLCHG.
           MOVE LN-TOTSERACCT TO HOLD-LN-TOTSERACCT.

      * PACESETTER DEFFRMLA 8 CAN HAVE LATE CHARGES
           IF REV-TRCD NOT = "WL"
              IF REVERSE-AFTER-RESCHED-FG = "N"
                 COMPUTE HOLD-LN-TOTLCHG = LN-TOTLCHG + LP-APLC.

           IF REV-TRCD NOT = "WI" AND
                        NOT DF-POSTING AND
                         NOT ADDON-POSTING
              COMPUTE HOLD-LN-TOTINT = LN-TOTINT + LP-APINT.

      * UCCC LATE CHARGES
      * CAN'T TAKE LATE CHARGE ON MONIES PAID WITHIN GRACE DAYS OF DUE DAY

           IF ( SP-LCFRMLA = "F" OR "H" OR "I" OR "J" OR "K"
                                 OR "L" OR "M" OR "P" OR "S" OR "T")
              IF REV-TRCD = "PY" OR "PA" OR "AL" OR "PE" OR "SS"
                         OR "PO" OR "PB" OR "SC" OR "RN" OR "IN"
                                 OR "RB" OR "RO" OR "PR" OR "PC"
                                 OR "PP" OR "AH" OR "PN" OR "PZ"
                 MOVE LP-LCPARTIALS TO HOLD-PARTIALS
                 MOVE LP-LCPAID TO HOLD-LCPAID.

           IF LN-SERVACCT NOT = "Y"
              GO TO BYPASS-SERVICE.

           ADD LP-EARNED(1) TO HOLD-LN-TOTSERACCT.

      * EARNED INTEREST
           ADD LP-EARNED(2) TO HOLD-LN-TOTSERACCT.
      * EARNED LCHG
           ADD LP-EARNED(3) TO HOLD-LN-TOTSERACCT.

       BYPASS-SERVICE.
           MOVE "RV" TO LP-TRCD.

      * LET REVERSAL 'RV' RECORD HAVE THE LP-PAYDATE OF THE
      * RECORD BEING REVERSED:
           MOVE TRANS-DATE TO LP-TRDATE LP-PAYDATE.

      ***********************************************************
      * LOGIC FROM BEGINNING OF DISPLAY-ENTRY-LINE IN LONPF8:
      ***********************************************************
           SUBTRACT LP-APCUR FROM LP-CURBAL.

      * CANT CHANGE LN-REC IN HERE! LONPF2 WILL EXIT IF LN-REC DOESNT
      * MATCH WK-SAVE-RECORD
           MOVE LN-TOTPAYMNTD TO HOLD-LN-TOTPAYMNTD.

      * UPDATE CONTRACTUAL PAYMENTS TO DATE:
           ADD LP-APCUR TO LN-TOTPAYMNTD
           IF SP-CAL-RATETYPE(1) = "Z"
              SUBTRACT LP-EXTRA-PRIN-LFP FROM LN-TOTPAYMNTD
              ADD LP-EXTRA-PRIN-LFP        TO LN-TOTEXCPAYMNTD.
           IF SP-CONTRFRMLA = "A"
              ADD LP-APLC TO LN-TOTPAYMNTD.
           ADD LP-APINT TO LN-TOTPAYMNTD.

      * COMPUTE PAID THRU DATE
           MOVE LN-1STPYDATE TO PDTH-DATE-WORK.
           PERFORM PAID-THRU-CALCULATION.
           MOVE PDTH-DATE-FULL TO LP-PDTH-DATE.

      * CANT CHANGE LN-REC IN HERE! LONPF2 WILL EXIT IF LN-REC DOESNT
      * MATCH WK-SAVE-RECORD
           MOVE HOLD-LN-TOTPAYMNTD TO LN-TOTPAYMNTD.

           MOVE BP-TRCD TO HOLD-BP-TRCD LP-TRCD.
           MOVE BP-REFCD TO LP-REFNO HOLD-LP-REFNO.

      * PAYMENT UPDATE

           MOVE LN-ACCTNO TO LOAN-KEY.
           MOVE LN-SSNO(1) TO BORROWER-KEY.

       REVERSAL-SAVE-SCREEN.
           MOVE 3 TO WK-KEY.
           PERFORM OPEN-WK-FILE.

           MOVE 0 TO WK-ELE.

      * THIS DOESNT GET DONE IN LONPF8, BUT LONPF1 DOES SET IT, SO IT MUST
      * GET DONE HERE, WITH NO CHANGES MADE TO THE LN-REC IN THIS PROGRAM!
           MOVE LN-REC TO WK-SAVE-RECORD.
           MOVE LP-REC TO WK-LP-REC.
           MOVE LX-REC TO WK-LX-REC.
           MOVE LXE-REC TO WK-LXE-REC.
           MOVE LXG-REC TO WK-LXG-REC.
           PERFORM WRITE-WK-FILE.
           IF IO-FG NOT = 0
              PERFORM REWRITE-WK-FILE.
           PERFORM CLOSE-WK-FILE.

       CALL-LONPF2-FOR-REVERSAL.

           MOVE "LP/LONPF2" TO FORM-NAM.
           CALL FORM-PROGX USING FORM-PATH EXIT-PATHNAME
                                 PROG-BUF  UPDATE-BUF.
           CANCEL FORM-PROGX.

      * TEST PROG-BUF (ERRCD) TO MAKE SURE LONPF2 DID NOT REJECT
      * THE PROPOSED TRANSACTION
      
           IF ERRCD = "E" OR "X" OR "M"
              MOVE "LONPF2: PMT NOT APPLIED  " TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              MOVE "E" TO POSTING-ERRCD
              GO TO PAYMENT-POSTING-EXIT.

       REVERSAL-RTN-EXIT.
           EXIT.


      **************************************************
       SETUP-LP-RECORD SECTION.
      **************************************************
           PERFORM CLEAR-LP-FILE.

           MOVE LN-STATUSFG    TO LP-STATUSFG.
           MOVE LN-ACCTNO      TO LP-ACCTNO.
           MOVE TRANS-DATE     TO LP-TRDATE.
           MOVE BP-PAYDATE     TO LP-PAYDATE.
           MOVE LN-SSNO(1)     TO LP-SSNO.
           MOVE LN-LCPDTH-DATE TO LP-LCPDTH-DATE.
      * BECAUSE CASH DRAWER IS NEVER REALY UPDATED DURING THE UPDATE
      * OF A "PA",ETC TRANSACTION, WE DECIDED TO DEFAULT THE DRAWER
      * NUMBER TO ZERO RATHER THAN MAKE THE USER ENTER A UNUSED #.
           MOVE 0              TO LP-TILLNO.
           MOVE BATCH-REFCD    TO LP-REFNO.

           PERFORM CLEAR-LXG-FILE.

           MOVE LP-BRNO   TO LXG-BRNO.
           MOVE LP-ACCTNO TO LXG-ACCTNO.

      **************************************************
       SETUP-LONPF-BUFFER SECTION.
      **************************************************
           MOVE 0   TO ENTRY-FLAG BYPASS-AMT-ENT-FG.
           MOVE "F" TO FULL-DISPLAY.
           MOVE " " TO REV-REBATE FULL-PAGE-FG ENTER-AMT-FG
                       HOLD-DISPLAY-ERN
                       HOLD1-KEY-DOWN HOLD2-KEY-UP.

           MOVE LN-ORGST    TO SP-ORGST.
           MOVE LN-SPRCLASS TO SP-SPRCLASS.
           MOVE LN-SUBCLASS TO SP-SUBCLASS.
           MOVE LN-LAWCODE  TO SP-LAWCODE.

           MOVE 0 TO HOLD-PARTIALS
                     HOLD-LCPAID
                     HOLD-DLPARVHELD-ADJ
                     HOLD-AFPDLLP
                     HOLD-OVPAID-CHECK
                     HOLD-REPO-AUCTION-EXP
                     ADDON-INT-REBATE
                     ADDON-INT-EARNED
      * ADDED 10/15/2021, WRITE ERROR TRPFILE LONPF2
      * CONVERSION FAILED WHEN CONVERTING DATE (22007) 
                     HOLD-PRIOR-DF-POSTDATE.

           IF BP-TRCD = "SS"
              MOVE BP-AUCTION-FEES TO HOLD-REPO-AUCTION-EXP
              MOVE BP-AUCTION-NAME TO HOLD-REPO-AUCTION-NAME.


           IF BP-TRCD = "PL" OR "P2" OR "P3"
              MOVE BP-PL-REASON TO HOLD-PLREASON.

           MOVE LN-TOTINT     TO HOLD-LN-TOTINT.
           MOVE LN-TOTERN     TO HOLD-LN-TOTERN.
           MOVE LN-TOTDEF     TO HOLD-LN-TOTDFMNTS.
           MOVE LN-TOTLCHG    TO HOLD-LN-TOTLCHG.
           MOVE LN-TOTSERACCT TO HOLD-LN-TOTSERACCT.
           MOVE LN-JDRATE     TO HOLD-LN-JDRATE.

           PERFORM VARYING SUB FROM 1 BY 1 UNTIL SUB > 13
              MOVE 0 TO REB-AMOUNT(SUB)
              IF SUB < 7
                 MOVE LN-ACCERN(SUB) TO HOLD-LN-ACCERN(SUB)
              END-IF
              IF SUB < 9
                 MOVE " " TO INS-RB-TBL(SUB)
              END-IF
           END-PERFORM.

           MOVE LN-ACCTNO TO LOAN-KEY.
           MOVE LN-SSNO(1) TO BORROWER-KEY.
           PERFORM SAVE-SCREEN.

      ******************************************************************
       MAIN-EXCEPTION SECTION.
      ******************************************************************
           IF DUP-FLAG = "Y"
              ADD ORIG-BP-TRAMT     TO AMOUNT-DUPS(1)
                                       AMOUNT-DUPS(2)
              ADD 1 TO TOTAL-DUPS(1)
                       TOTAL-DUPS(2)
           ELSE
              IF (POSTING-ERRCD NOT = "O") AND
                 (HOLD-OVPAID-CHECK = 0  )
                 ADD ORIG-BP-TRAMT     TO AMOUNT-EXCEPTION(1)
                                          AMOUNT-EXCEPTION(2)
                 ADD 1 TO TOTAL-EXCEPTION(1)
                          TOTAL-EXCEPTION(2).

           MOVE " " TO DUP-FLAG.
           MOVE "N" TO FIRST-TIME.
           PERFORM EXCEPTION-LINE-PROCESS.
           MOVE "E" TO BP-UPDFG.
           PERFORM REWRITE-BP1-FILE.

       EXIT-MAIN-EXCEPTION.
           EXIT.


      ******************************************************************
       REPO-EXCEPTION SECTION.
      ******************************************************************
           IF DUP-FLAG = "Y"
              ADD ORIG-BP-TRAMT     TO REPO-AMOUNT-DUPS(1)
                                       REPO-AMOUNT-DUPS(2)
              ADD 1 TO TOTAL-DUPS(1)
                       TOTAL-DUPS(2)
           ELSE
              IF (POSTING-ERRCD NOT = "O") AND
                 (HOLD-OVPAID-CHECK = 0  )
                 ADD ORIG-BP-TRAMT     TO REPO-AMOUNT-EXCEPTION(1)
                                         REPO-AMOUNT-EXCEPTION(2)
                 ADD 1 TO REPO-TOTAL-EXCEPTION(1)
                          REPO-TOTAL-EXCEPTION(2).

           MOVE " " TO DUP-FLAG.
           MOVE "N" TO FIRST-TIME.
           MOVE "R" TO REPO-CODE.
           PERFORM REPO-EXCEPTION-LN-PROCESS.
           MOVE "E" TO BP-UPDFG.
           PERFORM REWRITE-BP1-FILE.
           MOVE " " TO REPO-CODE.

       EXIT-REPO-EXCEPTION.
           EXIT.

      ******************************************************************
       ACH-EXCEPTION SECTION.
      ******************************************************************
           ADD ORIG-BP-TRAMT     TO AMOUNT-EXCEPTION(1)
                                    AMOUNT-EXCEPTION(2).
           ADD 1 TO TOTAL-EXCEPTION(1)
                    TOTAL-EXCEPTION(2).

           MOVE " " TO DUP-FLAG.
           PERFORM EXCEPTION-LINE-PROCESS.
           MOVE "E" TO BP-UPDFG.
           PERFORM REWRITE-BP1-FILE.

       EXIT-ACH-EXCEPTION.
           EXIT.

      ******************************************************************
       INITIALIZATION SECTION.
      ******************************************************************

           MOVE USER-PID TO TEMP-PID.

           MOVE BRANCH TO HOLD-PROG-BUF-BRANCH.

           IF ( EXT-ROUTE-BUF = "00" )
              MOVE BATCH TO WR-BUF
              MOVE BATCH-NO-LIST TO WR-LIST
              PERFORM CALL-WRFORM
              MOVE BATCH-REFCD TO WR-BUF
              MOVE BATCH-REFCD-LIST TO WR-LIST
              PERFORM CALL-WRFORM
              MOVE BATCH-REFCD TO WR-BUF
              MOVE SPOOL-REFCD-LIST TO WR-LIST
              PERFORM CALL-WRFORM.

           MOVE " " TO ERRCD.

           IF BATCH < GP-REFCD-NEXT-BATCH-START OR
              BATCH > GP-REFCD-NEXT-BATCH-STOP
              IF ( EXT-ROUTE-BUF = "00" )
                 MOVE "INVALID REFCD BATCH NUMBER" TO MESS
                 PERFORM SEND-MESS
              END-IF
              MOVE "X" TO ERRCD
              GO TO END-INIT.

           IF ( EXT-ROUTE-BUF NOT = "00" )
              PERFORM CREATE-WK-FILE
              GO TO SKIP-OK-YN.

       OK-YN.
           MOVE "E  A010ACCEPT." TO VDU.
           PERFORM SCREENIO.
           IF VDUSTATUS = "10" GO TO OK-YN.
           IF VDUSTATUS = "1>" GO TO END-INIT.
           IF VDUSTATUS NOT = "00" GO TO OK-YN.
           IF VDUBUF NOT = "Y" GO TO OK-YN.

           IF ( EXT-ROUTE-BUF = "00" )
              MOVE "UPDATE IN PROGRESS......." TO MESS-BUF
              MOVE 0 TO MESS-BRNO
              MOVE MESS-BUF TO WR-BUF
              MOVE MESS-LIST TO WR-LIST
              PERFORM CALL-WRFORM.

       SKIP-OK-YN.
           MOVE EXT-CONAME-USER-ID TO H-USERID TEST-USERID.
           MOVE EXT-CONAME-CONAME TO H-NAME.
           MOVE EXT-CONAME-SYSDATE TO H-DATE.
           MOVE " " TO HOLD-SP1-KEY.

           MOVE BATCH-REFCD TO H-REFCD.

      * CREATE SPOOL DIRECTORY AND OPEN SPOOL FILE IN 'EO'

           MOVE BATCH-REFCD TO SAVE-EX-SPOOL-NAME.
           PERFORM CREATE-SPOOL-DIR.
           IF ERRCD NOT = " "
              GO TO END-INIT.
           MOVE EX-SPOOL TO SUMMARY-SPOOL PRU-FILE.

           PERFORM OPEN-PR-FILE.
           IF IO-FG NOT = 0
              GO TO END-INIT.
           PERFORM CLOSE-PR-FILE.

           MOVE "EXCEPT" TO SAVE-EX-SPOOL-NAME.
           PERFORM CREATE-SPOOL-DIR.
           IF ERRCD NOT = " "
              GO TO END-INIT.

           MOVE EX-SPOOL TO EXCEPT-SPOOL PRU-FILE.
           PERFORM OPEN-PR-FILE.
           IF IO-FG NOT = 0
              GO TO END-INIT.
           PERFORM CLOSE-PR-FILE.

           MOVE "REPOEX"   TO SAVE-EX-SPOOL-NAME.
           PERFORM CREATE-SPOOL-DIR.
           IF ERRCD NOT = " "
               GO TO END-INIT.
           MOVE EX-SPOOL TO REPOEX-SPOOL PRU-FILE.
           IF STAT = "00"
              PERFORM OPEN-PR-FILE-EXTEND
           ELSE
              PERFORM OPEN-PR-FILE.
           IF IO-FG NOT = 0
              GO TO END-INIT.
           PERFORM CLOSE-PR-FILE.

           MOVE SUMMARY-SPOOL TO PRU-FILE.
           PERFORM OPEN-PR-FILE-EXTEND.
           IF IO-FG NOT = 0
              GO TO END-INIT.

           PERFORM OPEN-BR-FILE.
           PERFORM OPEN-GI1-FILE.
           PERFORM OPEN-CD1-FILE.
      * MUST LEAVE SP1-FILE OPEN BECAUSE ADDONSPR READS IT
           PERFORM OPEN-SP1-FILE.

           MOVE BATCH-REFCD TO LP-REFNO.

      * GET CD REC FOR 'BATCH-REFCD'

           MOVE "BR"        TO CD-TYPE.
           MOVE BATCH-REFCD TO CD-CODE SAVE-BP-WK-REFCD.
           PERFORM READ-CD1-FILE.
           IF IO-BAD OR (CD-BR-FILE-TYPE = "C")
              IF ( EXT-ROUTE-BUF = "00" )
                 MOVE "BATCH REFERENCE CODE NOT ON FILE" TO MESS
                 PERFORM SEND-MESS
              END-IF
              GO TO END-INIT
           ELSE
              MOVE CD-BR-LC-FG           TO BATCH-REFCD-LC-FG
              MOVE CD-BR-MULTIPLE-REFCDS TO HOLD-BATCH-MULTIPLE-REFCDS
              MOVE CD-BR-FILE-NAME       TO BT-PATH-SHORT-NAME
              MOVE CD-BR-PAYOFF-FG       TO HOLD-CD-BR-PAYOFF-FG
              MOVE CD-BR-POST-SS-TRCD    TO HOLD-CD-BR-POST-SS-TRCD.

           MOVE 0 TO HOLD-OVPAID-CHECK.

           GO TO EXIT-INITIALIZE.
       END-INIT.
           MOVE 1 TO ERRCD.
       EXIT-INITIALIZE.
           EXIT.

      ******************************************************************
       EXCEPTION-LINE-PROCESS SECTION.
      ******************************************************************
           PERFORM CLOSE-PR-FILE.
           MOVE EXCEPT-SPOOL TO PRU-FILE.
           PERFORM OPEN-PR-FILE-EXTEND.
           MOVE BR-NO TO D-BRNO.
           IF NOT-ON-FILE-FG = "Y"
              MOVE BP-LNNO TO D-LNNO
              MOVE BP-SSNO TO D-SSNO
              INSPECT D-SSNO REPLACING ALL "/" BY "-"
      * ONLY PRINT LAST 4 OF SSNO
              MOVE ALL "X" TO D-SOC1 D-SOC2
              PERFORM PROCESS-BORROWER
              MOVE BP-TRAMT TO D-TRAMT
              MOVE BP-REFCD TO D-REFCD
              MOVE BP-PAYDATE TO DATE-YYYYMMDD
              PERFORM CONVERT-YYYYMMDD-TO-MMDDYY
              MOVE DATE-MMDDYY TO D-PAYDATE
              IF (USER-BR-1ST NOT = 3)
                 MOVE BP-CLAIM-NUMBER TO D-CLAIM-NUMBER
                 MOVE BP-PMT-TYPE TO D-PMT-TYPE
              END-IF
              MOVE 2 TO LN-FEED
              PERFORM WRITE-EXCEPTION-LINE
              GO TO END-EXCEPT-LN-PROCESS.

           PERFORM PROCESS-BORROWER.
           PERFORM LPSTAT-DISPLAY.
           MOVE LPS-DISPLAY-LNNO TO D-LOAN-NUM.

      * ALWAYS DISPLAY SOCIAL FROM BP EVEN IF IT IS INVALID. IT WILL
      * MAKE IT EASIER TO BACKTRACK IF PAYMENT DOES NOT POST
           MOVE BP-SSNO    TO D-SSNO.
           INSPECT D-SSNO REPLACING ALL "/" BY "-".
      * ONLY PRINT LAST 4 OF SSNO
           MOVE ALL "X" TO D-SOC1 D-SOC2.
           MOVE ORIG-BP-TRAMT TO D-TRAMT.
           MOVE BP-REFCD TO D-REFCD.
           MOVE BP-PAYDATE TO DATE-YYYYMMDD.
           PERFORM CONVERT-YYYYMMDD-TO-MMDDYY.
           MOVE DATE-MMDDYY TO D-PAYDATE.
           IF (USER-BR-1ST NOT = 3)
              MOVE BP-CLAIM-NUMBER TO D-CLAIM-NUMBER
              MOVE BP-PMT-TYPE TO D-PMT-TYPE.
           MOVE 2 TO LN-FEED.
           PERFORM WRITE-EXCEPTION-LINE.

       END-EXCEPT-LN-PROCESS.
           PERFORM CLOSE-PR-FILE.
           MOVE SUMMARY-SPOOL TO PRU-FILE.
           PERFORM OPEN-PR-FILE-EXTEND.

      ******************************************************************
       REPO-EXCEPTION-LN-PROCESS SECTION.
      ******************************************************************
           PERFORM CLOSE-PR-FILE.
           MOVE REPOEX-SPOOL TO PRU-FILE.
           PERFORM OPEN-PR-FILE-EXTEND.
           MOVE BR-NO TO D-BRNO.
           IF NOT-ON-FILE-FG = "Y"
              MOVE BP-LNNO TO D-LNNO
              MOVE BP-SSNO TO D-SSNO
              INSPECT D-SSNO REPLACING ALL "/" BY "-"
      * ONLY PRINT LAST 4 OF SSNO
              MOVE ALL "X" TO D-SOC1 D-SOC2
              PERFORM PROCESS-BORROWER
              MOVE BP-TRAMT TO D-TRAMT
              MOVE BP-REFCD TO D-REFCD
              MOVE BP-PAYDATE TO DATE-YYYYMMDD
              PERFORM CONVERT-YYYYMMDD-TO-MMDDYY
              MOVE DATE-MMDDYY TO D-PAYDATE
              IF (USER-BR-1ST NOT = 3)
                 MOVE BP-CLAIM-NUMBER TO D-CLAIM-NUMBER
                 MOVE BP-PMT-TYPE TO D-PMT-TYPE
              END-IF
              MOVE 2 TO LN-FEED
              PERFORM WRITE-REPO-EXCEPTION-LN
              GO TO END-REPO-EXCEPT-LN-PROCESS.

           PERFORM PROCESS-BORROWER.
           PERFORM LPSTAT-DISPLAY.
           MOVE LPS-DISPLAY-LNNO TO D-LOAN-NUM.

      * ALWAYS DISPLAY SOCIAL FROM BP EVEN IF IT IS INVALID. IT WILL
      * MAKE IT EASIER TO BACKTRACK IF PAYMENT DOES NOT POST
           MOVE BP-SSNO    TO D-SSNO.
           INSPECT D-SSNO REPLACING ALL "/" BY "-".
      * ONLY PRINT LAST 4 OF SSNO
           MOVE ALL "X" TO D-SOC1 D-SOC2.
           MOVE ORIG-BP-TRAMT TO D-TRAMT.
           MOVE BP-REFCD TO D-REFCD.
           MOVE BP-PAYDATE TO DATE-YYYYMMDD.
           PERFORM CONVERT-YYYYMMDD-TO-MMDDYY.
           MOVE DATE-MMDDYY TO D-PAYDATE.
           IF (USER-BR-1ST NOT = 3)
              MOVE BP-CLAIM-NUMBER TO D-CLAIM-NUMBER
              MOVE BP-PMT-TYPE TO D-PMT-TYPE.
           MOVE "REPO BATCH RECORD" TO D-EXCEPT.
           MOVE 2 TO LN-FEED.
           PERFORM WRITE-REPO-EXCEPTION-LN.

       END-REPO-EXCEPT-LN-PROCESS.
           PERFORM CLOSE-PR-FILE.
           MOVE SUMMARY-SPOOL TO PRU-FILE.
           PERFORM OPEN-PR-FILE-EXTEND.


      ******************************************************************
       EXCEPTION-TOTAL-PRINT SECTION.
      ******************************************************************
           PERFORM CLOSE-PR-FILE.
           MOVE EXCEPT-SPOOL TO PRU-FILE.
           PERFORM OPEN-PR-FILE-EXTEND.

           IF TOTAL-EXCEPTION(LEV) NOT = 0
              IF LEV = 1
                 MOVE "TOTAL EXCEPTIONS BR# &&&&" TO S-BRNAME
                 INSPECT S-BRNAME REPLACING FIRST "&&&&" BY BR-NO
              ELSE
                 MOVE "ALL BRANCHES EXCEPTIONS" TO S-BRNAME
              END-IF
              MOVE TOTAL-EXCEPTION(LEV)  TO S-NO-ERRORS
              MOVE AMOUNT-EXCEPTION(LEV) TO S-AMT-ERRORS
              MOVE 2 TO LN-FEED
              PERFORM WRITE-EXCEPTION-LINE.

           IF TOTAL-OVPAID(LEV) NOT = 0
              IF LEV = 1
                 MOVE "TOTAL OVERPAYS BR# &&&&" TO S-BRNAME
                 INSPECT S-BRNAME REPLACING FIRST "&&&&" BY BR-NO
              ELSE
                 MOVE "ALL BRANCHES OVERPAYS" TO S-BRNAME
              END-IF
              MOVE TOTAL-OVPAID(LEV)  TO S-NO-ERRORS
              MOVE AMOUNT-OVPAID(LEV) TO S-AMT-ERRORS
              MOVE 2 TO LN-FEED
              PERFORM WRITE-EXCEPTION-LINE.

       END-EXCEPTION-TOTAL-PRINT.
           PERFORM CLOSE-PR-FILE.
           MOVE SUMMARY-SPOOL TO PRU-FILE.
           PERFORM OPEN-PR-FILE-EXTEND.

      ******************************************************************
       REPO-EXCEPTION-TOTAL-PRINT SECTION.
      ******************************************************************
           PERFORM CLOSE-PR-FILE.
           MOVE REPOEX-SPOOL TO PRU-FILE.
           PERFORM OPEN-PR-FILE-EXTEND.

           IF REPO-TOTAL-EXCEPTION(LEV) NOT = 0
              IF LEV = 1
                 MOVE "TOTAL EXCEPTIONS BR# &&&&" TO S-BRNAME
                 INSPECT S-BRNAME REPLACING FIRST "&&&&" BY BR-NO
              ELSE
                 MOVE "ALL BRANCHES EXCEPTIONS" TO S-BRNAME
              END-IF
              MOVE REPO-TOTAL-EXCEPTION(LEV)  TO S-NO-ERRORS
              MOVE REPO-AMOUNT-EXCEPTION(LEV) TO S-AMT-ERRORS
              MOVE 2 TO LN-FEED
              PERFORM WRITE-EXCEPTION-LINE.

       END-REPO-EXCEPT-TOT-PRINT.
           PERFORM CLOSE-PR-FILE.
           MOVE SUMMARY-SPOOL TO PRU-FILE.
           PERFORM OPEN-PR-FILE-EXTEND.

      ******************************************************************
       PROCESS-BORROWER SECTION.
      ******************************************************************
           MOVE SPACES TO D-NAME.

      * ALWAYS DISPLAY SOCIAL FROM BP EVEN IF IT IS INVALID. IT WILL
      * MAKE IT EASIER TO BACKTRACK IF PAYMENT DOES NOT POST
           MOVE BP-SSNO TO BW-SSNO.
           PERFORM READ-BW1-FILE.
           IF IO-FG NOT = 0
              MOVE "**NOT ON FILE**" TO D-NAME
              GO TO END-PROCESS-BORROWER.

           MOVE SPACES TO NAME-WORKER.
           STRING BW-LNAME,", ",BW-FNAME DELIMITED BY "   "
                 INTO NAME-WORKER.
           MOVE NAME-WORKER TO D-NAME.

       END-PROCESS-BORROWER.
           EXIT.

      ******************************************************************
       WRITE-SUMMARY-LINE SECTION.
      ******************************************************************
           ADD LN-FEED LN-COUNT1 GIVING LN-WK.
           IF LN-WK > EXT-CONAME-RPT-LINES
              PERFORM SUMMARY-HEAD-PAGE.
           MOVE DETAIL-LINE TO PR-REC.
           PERFORM WRITE-PR-REC.
           ADD LN-FEED TO LN-COUNT1.
           MOVE 1 TO LN-FEED.
           MOVE " " TO DETAIL-LINE.

      ******************************************************************
       WRITE-EXCEPTION-LINE SECTION.
      ******************************************************************
           ADD LN-FEED LN-COUNT2 GIVING LN-WK.
           IF LN-WK > EXT-CONAME-RPT-LINES
              PERFORM EXCEPTION-HEAD-PAGE.
           MOVE DETAIL-LINE TO PR-REC.
           PERFORM WRITE-PR-REC.
           ADD LN-FEED TO LN-COUNT2.
           MOVE 1 TO LN-FEED.
           MOVE " " TO DETAIL-LINE.



      ******************************************************************
       WRITE-REPO-EXCEPTION-LN SECTION.
      ******************************************************************
           ADD LN-FEED LN-COUNT3 GIVING LN-WK.
           IF LN-WK > EXT-CONAME-RPT-LINES
              PERFORM EXCEPTION-HEAD-PAGE.
           MOVE DETAIL-LINE TO PR-REC.
           PERFORM WRITE-PR-REC.
           ADD LN-FEED TO LN-COUNT3.
           MOVE 1 TO LN-FEED.
           MOVE " " TO DETAIL-LINE.


      ******************************************************************
       SUMMARY-HEAD-PAGE SECTION.
      ******************************************************************
           ADD 1 TO PAGE-NUMBER1.
           MOVE PAGE-NUMBER1 TO H-PAGE-NO.
           PERFORM GET-TIME.
           MOVE T-HH TO H-HR.
           MOVE T-MM TO H-MIN.

           MOVE HEAD1 TO PR-REC.
           MOVE 99 TO LN-FEED.
           PERFORM WRITE-PR-REC.

           MOVE "BATCH PROCESSING SUMMARY REPORT FOR REF CODE: "
              TO H-TITLE.
           MOVE BATCH TO H-BATCH.
           MOVE HEAD2 TO PR-REC.
           MOVE 1 TO LN-FEED.
           PERFORM WRITE-PR-REC.

           MOVE SUMMARY-HEAD TO PR-REC.
           MOVE 2 TO LN-FEED.
           PERFORM WRITE-PR-REC.

       END-SUMMARY-HEAD-PAGE.
           MOVE 4 TO LN-COUNT1.
           MOVE 2 TO LN-FEED.

      ******************************************************************
       EXCEPTION-HEAD-PAGE SECTION.
      ******************************************************************
           IF REPO-CODE = "R"
              ADD 1 TO PAGE-NUMBER3
              MOVE PAGE-NUMBER3 TO H-PAGE-NO
           ELSE
             ADD 1 TO PAGE-NUMBER2
              MOVE PAGE-NUMBER2 TO H-PAGE-NO.
           PERFORM GET-TIME.
           MOVE T-HH TO H-HR.
           MOVE T-MM TO H-MIN.

           MOVE HEAD1 TO PR-REC.
           MOVE 99 TO LN-FEED.
           PERFORM WRITE-PR-REC.

           MOVE "BATCH PROCESSING EXCEPTION REPORT FOR REF CODE: "
              TO H-TITLE.
           IF REPO-CODE = "R"
              MOVE
              "BATCH PROCESSING REPO EXCEPTION REPORT FOR REF CODE:"
                                                       TO H-TITLE.
           MOVE BATCH TO H-BATCH.
           MOVE HEAD2 TO PR-REC.
           MOVE 1 TO LN-FEED.
           PERFORM WRITE-PR-REC.

           IF (USER-BR-1ST NOT = 3)
              MOVE " CLAIM #  PMT TYPE  " TO HEAD3-VAR.
           MOVE HEAD3 TO PR-REC.
           MOVE 2 TO LN-FEED.
           PERFORM WRITE-PR-REC.

       END-EXCEPTION-HEAD-PAGE.
           IF REPO-CODE = "R"
              MOVE 4 TO LN-COUNT3
           ELSE
              MOVE 4 TO LN-COUNT2.
           MOVE 2 TO LN-FEED.

      ******************************************************************
       SAVE-SCREEN SECTION.
      ******************************************************************
           MOVE 3 TO WK-KEY.
           PERFORM OPEN-WK-FILE.

           MOVE SPACES TO WK-SAVE-RECORD.
           MOVE 0      TO WK-ELE.

           MOVE LN-REC  TO WK-SAVE-RECORD.
           MOVE LP-REC  TO WK-LP-REC.
           MOVE LX-REC  TO WK-LX-REC.
           MOVE LXG-REC TO WK-LXG-REC.

           MOVE 0       TO LXE-EARN(1)
                           LXE-EARN(2)
                           LXE-EARN(3)
                           LXE-EARN(4)
                           LXE-EARN(5)
                           LXE-EARN(6)
                           LXE-EARN(7).
           IF SP-ERNFRMLA(1) = 15 OR SP-ERNFRMLA(5) = 16
              MOVE LN-ERN-IB-INTOWE TO LXE-WORKER
           ELSE
              MOVE 0                TO LXE-WORKER.
           MOVE 0 TO LXE-WORKER2.
           MOVE LXE-REC TO WK-LXE-REC.

           PERFORM WRITE-WK-FILE.
           IF IO-FG NOT = 0
              PERFORM REWRITE-WK-FILE.
       EXIT-SAVE-SCREEN.
           PERFORM CLOSE-WK-FILE.

      ******************************************************************
       RESTORE-SCREEN SECTION.
      ******************************************************************
           MOVE 3 TO WK-KEY.
           PERFORM OPEN-WK-FILE.
           PERFORM READ-WK-FILE.
           IF NEW-FORM NOT = OLD-FORM
              MOVE OLD-PROG-FORM TO WK-OLD-PROG-FORM
              MOVE NEW-PROG-FORM TO OLD-PROG-FORM.
           IF IO-FG = 0
              GO TO RESTORE-CLEAR.

           MOVE 0 TO WK-ELE.
           PERFORM WRITE-WK-FILE.
           IF IO-FG = 9
              GO TO IO-ERROR.

           GO TO EXIT-RESTORE-SCREEN.
       RESTORE-CLEAR.
           MOVE WK-SAVE-RECORD TO LN-REC.
           MOVE WK-LP-REC      TO LP-REC.
           MOVE WK-LX-REC      TO LX-REC.
           MOVE WK-LXE-REC     TO LXE-REC.
           MOVE WK-LXG-REC     TO LXG-REC.
           MOVE 0              TO WK-ELE.
           PERFORM REWRITE-WK-FILE.
       EXIT-RESTORE-SCREEN.
           PERFORM CLOSE-WK-FILE.

      ******************************************************************
       PRINT-TOTALS SECTION.
      ******************************************************************
           IF LEV = 1
              MOVE BR-NO TO SUMMARY-LINE
              MOVE BR-NAME TO S-BRNAME
           ELSE
              MOVE "****" TO SUMMARY-LINE
              MOVE "GRAND TOTAL: " TO S-BRNAME.

           MOVE TOTAL-READ(LEV)    TO S-NO-READ.
           MOVE AMOUNT-READ(LEV)   TO S-AMT-READ.

           MOVE TOTAL-POSTED(LEV)  TO S-NO-WRITTEN.
           MOVE AMOUNT-POSTED(LEV) TO S-AMT-WRITTEN.

           MOVE TOTAL-EXCEPTION(LEV)  TO S-NO-ERRORS.
           MOVE AMOUNT-EXCEPTION(LEV) TO S-AMT-ERRORS.

           MOVE TOTAL-OVPAID(LEV) TO S-NO-OVERPAY.
           MOVE AMOUNT-OVPAID(LEV)  TO S-AMT-OVERPAY.

           MOVE 2 TO LN-FEED.
           PERFORM WRITE-SUMMARY-LINE.

           IF (TOTAL-EXCEPTION(LEV) NOT = 0
            OR TOTAL-OVPAID(LEV) NOT = 0)
               PERFORM EXCEPTION-TOTAL-PRINT.

           IF (REPO-TOTAL-EXCEPTION(LEV)) NOT = 0
               PERFORM REPO-EXCEPTION-TOTAL-PRINT.

      * CLEAR TOTALS AFTER PRINTING
      
           MOVE 0 TO AMOUNT-READ(LEV)      TOTAL-READ(LEV)
                AMOUNT-EXCEPTION(LEV) TOTAL-EXCEPTION(LEV)
                AMOUNT-POSTED(LEV)    TOTAL-POSTED(LEV)
                AMOUNT-DUPS(LEV)      TOTAL-DUPS(LEV)
                AMOUNT-OVPAID(LEV)    TOTAL-OVPAID(LEV).

           MOVE 0 TO REPO-AMOUNT-READ(LEV) REPO-TOTAL-READ(LEV)
                REPO-AMOUNT-EXCEPTION(LEV) REPO-TOTAL-EXCEPTION(LEV)
                REPO-AMOUNT-POSTED(LEV)   REPO-TOTAL-POSTED(LEV)
                REPO-AMOUNT-DUPS(LEV)     REPO-TOTAL-DUPS(LEV)
                REPO-AMOUNT-OVPAID(LEV)   REPO-TOTAL-OVPAID(LEV).

       EXIT-PRINT-TOTALS.
           EXIT.

      ******************************************************************
      *
      *  CREATE SPOOL DIRECTORY IN /XXX/XXXX/R#/EO
      *
      * STORE SPOOL FILE NAME AS /XXX/XXXX/R$/EO/....
      * WE NEED A FULL PATH NAME HERE ELSE DIR WILL CHANGE WHEN WE
      * CHANGE DIRECTORIES TO ANOTHER BRANCH.
      *
      * CHANGED TO ACCESS AS ../../ORIG/R1/EO/STEPBPREF, WITH ORIG
      * BEING ORIG DATA PATH, FULL PATH TOO LONG FOR ACCESS-BUF
      ******************************************************************
       CREATE-SPOOL-DIR SECTION.
           MOVE " " TO ERRCD.
           MOVE EXT-FILPATH-BASE      TO EX-SPOOL-BASE.
           MOVE EXT-FILPATH-MACHINE   TO EX-SPOOL-MACHINE.
           MOVE HOLD-EXT-FILPATH-DATA TO EX-SPOOL-DATA-PATH.
           MOVE TRANS-DATE            TO DATE-YYYYMMDD.
           PERFORM CONVERT-YYYYMMDD-TO-MMDDYY.
           MOVE DATE-MMDDYY           TO EX-SPOOL-DATE.
           MOVE " "                   TO EX-SPOOL-FILE.
           MOVE EX-SPOOL              TO DIR-ACCESS-BUF.
           PERFORM DIR-ACCESS-CALL.
           IF STAT NOT = "00"
              CALL "C$MAKEDIR" USING DIR-ACCESS-BUF GIVING STAT-99
              IF STAT NOT = "00"
                 IF ( EXT-ROUTE-BUF = "00" )
                    MOVE "CANNOT CREATE SPOOL DIRECTORY" TO MESS
                    PERFORM SEND-MESS
                    MOVE DIR-ACCESS-BUF TO MESS
                    PERFORM SEND-MESS
                 END-IF
                 MOVE "E" TO ERRCD
                 GO TO EXIT-CREATE-SPOOL-DIR.

           MOVE "/"                TO EX-SPOOL-FILE.
           MOVE SAVE-EX-SPOOL-NAME TO EX-SPOOL-NAME.
           MOVE "   "              TO EX-SPOOL-SUF.

      *****************************************************************
      * THEY ARE ALLOWED TO RUN THIS  MORE THAN ONCE ON THE
      * SAME TRANSACTION DATE, SO CHECK TO SEE IF REPORT EXISTS, IF
      * SO, INCREMENT THE STEP # SO WE DON'T WIPE OUT PRIOR REPORTS
      *****************************************************************
           MOVE 100 TO STEP-COUNT.
       TRY-NEXT-STEP-NO.
           MOVE STEP-COUNT TO EX-SPOOL-STEP.
           MOVE EX-SPOOL TO DIR-ACCESS-BUF.
           PERFORM DIR-ACCESS-CALL.
           IF STAT = "00"
             IF (EX-SPOOL-NAME = "REPOEX")
                GO TO EXIT-CREATE-SPOOL-DIR
             ELSE
             IF STEP-COUNT < 999
                ADD 1 TO STEP-COUNT
                GO TO TRY-NEXT-STEP-NO.

       EXIT-CREATE-SPOOL-DIR.
           EXIT.

      ******************************************************************
       BRANCH-EXCEPTION SECTION.
      ******************************************************************

      * THIS ROUTINE IS PERFORM WHEN NONE OF THE BRANCH'S ACCOUNTS CAN
      * BE PROCESSED, DUE TO CLOSED DAYS, NO OP-FILE, ETC.

           IF NOT (EXCEPTION-CODE = "LN" OR "SU")
              PERFORM OPEN-BW1-FILE
              PERFORM OPEN-LN1-FILE.

           PERFORM OPEN-BP1-FILE.
           MOVE 0 TO BP-LNNO BP-SEQNO.
           PERFORM START-BP1-FILE.

       BRANCH-EXCEPTION-NEXT-BP.
           PERFORM READ-BP1-FILE-NEXT.
           IF IO-FG NOT = 0
              GO TO END-BRANCH-EXCEPTION.

      * SKIP THE HEADER RECORD
      
           IF BP-LNNO = 0
              UNLOCK BP-FILE
              GO TO BRANCH-EXCEPTION-NEXT-BP.

           ADD 1 TO TOTAL-READ(1) TOTAL-READ(2).
           ADD BP-TRAMT TO AMOUNT-READ(1) AMOUNT-READ(2).

      * LNNO OF ALL 9'S ARE ALL ZEROS
      
           IF BP-LNNO = 99999999
              MOVE "Y" TO NOT-ON-FILE-FG
              MOVE "TOTAL OF ALL ZERO ACCTNO'S" TO D-EXCEPT
              PERFORM MAIN-EXCEPTION
              GO TO BRANCH-EXCEPTION-NEXT-BP.

           IF BP-UPDFG = "U" OR "E"
              UNLOCK BP-FILE
              GO TO BRANCH-EXCEPTION-NEXT-BP.

           IF (EXCEPTION-CODE = "LN" OR "SU")
              MOVE "Y" TO NOT-ON-FILE-FG
           ELSE
              MOVE BR-NO   TO LN-OWNBR
              MOVE BP-LNNO TO LN-ACCTNO
              PERFORM READ-LN1-FILE
              IF IO-FG NOT = 0
                 MOVE "Y" TO NOT-ON-FILE-FG
              ELSE
                 MOVE " " TO NOT-ON-FILE-FG.

           EVALUATE EXCEPTION-CODE
              WHEN 'A1' MOVE "DAY IS NOT OPEN          " TO D-EXCEPT
              WHEN 'LN' MOVE "LOAN FILE NOT FOUND      " TO D-EXCEPT
              WHEN 'OP' MOVE "CANNOT RESERVE OP FILE   " TO D-EXCEPT
              WHEN 'SU' MOVE "CANNOT ACCESS BRANCH     " TO D-EXCEPT
           END-EVALUATE.
           MOVE BP-TRAMT TO ORIG-BP-TRAMT.

           PERFORM MAIN-EXCEPTION.

           GO TO BRANCH-EXCEPTION-NEXT-BP.

       END-BRANCH-EXCEPTION.
           IF NOT (EXCEPTION-CODE = "LN" OR "SU")
              PERFORM CLOSE-LN1-FILE
              PERFORM CLOSE-BW1-FILE.

      ******************************************************************
       MOVE-BTFILE SECTION.
      ******************************************************************

      *  FOR EX:   MV ../../ED/EZPAY1121123 ../../ED/DONE/EZPAY1121123

           MOVE TRANS-DATE TO NUM-DATE.
           MOVE 0    TO NUM-CCYY.
           MOVE EXT-FILPATH-BASE    TO BT-PATH-BASE.
           MOVE EXT-FILPATH-MACHINE TO BT-PATH-MACHINE.
           MOVE NUM-DATE            TO BT-PATH-BATCH-DATE.
           MOVE BATCH               TO BT-PATH-BATCH-NO.
           MOVE BT-PATH TO ACCESS-BUF.
           PERFORM ACCESS-CALL.
           IF STAT NOT = "00"
              GO TO EXIT-MOVE-BTFILE.

           MOVE EXT-FILPATH-BASE    TO BT-DONE-BASE.
           MOVE EXT-FILPATH-MACHINE TO BT-DONE-MACHINE.
           MOVE BT-DONE-DIRECTORY   TO DIR-ACCESS-BUF.
           PERFORM DIR-ACCESS-CALL.
           IF STAT NOT = "00"
              CALL "C$MAKEDIR" USING DIR-ACCESS-BUF  GIVING
                                                STAT-99
              IF STAT NOT = "00"
                 IF ( EXT-ROUTE-BUF = "00" )
                    MOVE "CANNOT CREATE DONE DIRECTORY" TO MESS
                    PERFORM SEND-MESS
                 END-IF
                 GO TO EXIT-MOVE-BTFILE.
           STRING MV-CMD
                  " "
                  BT-PATH
                  " "
                  BT-DONE-PATH
                  DELIMITED BY SIZE INTO SYSTEM-BUF.
           PERFORM SYSTEM-CALL.

       EXIT-MOVE-BTFILE.
            EXIT.

      ******************************************************************
       CREATE-WK-FILE SECTION.
      ******************************************************************

      *  CREATE WK-FILE, IF RUNNING FROM EOCRON, WORK FILE IN /USR/TMP
      *  WAS NOT CREATED IN LONPA0

           MOVE MKTEMP-DEFAULT TO MKTEMP-BUF.
           PERFORM MKTEMP-CALL.

      * WK-FILE FOR LOAN PROCESSING USED PROCESS ID XL(PROCESS ID)

           MOVE PROCESS-ID-BUF TO USER-PID TEMP-PID.
           MOVE 9 TO IO-FG.
           PERFORM OPEN-IT.
           MOVE WK-IFN TO E-FILE.
       OPEN-WK-OUTPUT.
           OPEN OUTPUT WK-FILE.
           IF ( IO-FG = 8 )
              GO TO OPEN-WK-OUTPUT.
           IF ( IO-FG = 7 )
              PERFORM CLOSE-WK-FILE
              GO TO OPEN-WK-OUTPUT.
           PERFORM CLOSE-WK-FILE.

      *********************************
      *   NAME: CDV-VERIFY
      *   DESC: VERIFY LP-TRCD & YIELD SUBSCRIPT
      *   IN  : LP-TRCD, CDV-NN
      *   OUT : CDV-SUB; 0 = NOT_FOUND
      *********************************
       CDV-VERIFY SECTION.
           MOVE 0 TO CDV-SUB.
       CDV-VERIFY-NEXT.
           ADD 1 TO CDV-SUB.
           MOVE CDV-CD(CDV-SUB) TO STAT.
           IF STAT = LP-TRCD
              GO TO CDV-VERIFY-EXIT.
           IF STAT NOT = " "
              GO TO CDV-VERIFY-NEXT.
           MOVE 0 TO CDV-SUB.
       CDV-VERIFY-EXIT.
           EXIT.

      ************************************
       VDU-CONVERT-FIELD SECTION.
      ************************************
           MOVE "00" TO STAT.
           MOVE VDU-FIELD-TO-CONVERT TO VDU-ALP-FIELD.
           EVALUATE TRUE
              COPY "LIBLP/LONPW9_EVA.CPY".
               WHEN OTHER   MOVE "2A" TO STAT.

      *************************************
       SETUP-LINK-INFO SECTION.
      *************************************
           MOVE LONPW9-HELP--FILE TO HELP-LINK-FILE.
           MOVE LONPW9-HELP--DIR TO HELP-LINK-DIR.


      *************************************
       FORM-RESET SECTION.
      *************************************
           MOVE LPLOAN-SYSDATE TO LONPW9-SYSDATE.
           MOVE EXT-CONAME-CONAME TO LONPW9-CONAME.
           DISPLAY LONPW9-SCREEN UPON TCLP-MAIN-WINDOW-HANDLE.
           MOVE LONPW9-FORM-FIELDS TO WR-BUF.
           MOVE LONPW9-FORM-LIST TO WR-LIST.
           PERFORM CALL-WRFORM.

       FORM-RESET-EXIT.
           EXIT.

      ******************************************************************
      *  MISCELLANEOUS SECTIONS
      ******************************************************************
       COPY "LIBGB/TIMEIO.CPY".
       COPY "LIBGB/GPENV.CPY".
       COPY "LIBGB/DATER.CPY".
       COPY "LIBLP/DEFPOL.CPY".
       COPY "LIBLP/SETCTBL.CPY".
       COPY "LIBLP/LPSTAT.CPY".
       COPY "LIBLP/LPIBPC.CPY".
       COPY "LIBLP/LPRATE.CPY".
       COPY "LIBLP/LPXDTE.CPY".
       COPY "LIBLP/LPLCAS.CPY".
       COPY "LIBGB/SPPDTH.CPY".
       COPY "LIBLP/LPLCHG.CPY".
       COPY "LIBLP/LPLCAP.CPY".
       COPY "LIBLP/LPMDTE.CPY".
       COPY "LIBLP/LPITRM.CPY".
       COPY "LIBLP/LPAMTS.CPY".
       COPY "LIBGB/REBATE.CPY".
       COPY "LIBLP/LPPOFF.CPY".
       COPY "LIBLP/LPPOF2.CPY".
       COPY "LIBGB/AGEING.CPY".
       COPY "LIBLP/LPUPWK.CPY".
       COPY "LIBLP/LPSCHD.CPY".
       COPY "LIBLP/LPCEPP.CPY".
       COPY "LIBLP/LPAPRS.CPY".
       COPY "LIBLP/LPAPRZ.CPY".
       COPY "LIBLP/LPUPER.CPY".
       COPY "LIBGB/SCREEN.CPY".
       COPY "LIBLP/LPPDUE.CPY".
       COPY "LIBGB/RBACT.CPY".
       COPY "LIBLP/ADDONSPR.CPY".
       COPY "LIBLP/LPLPCL.CPY".
       COPY "LIBLP/LPLXGCL.CPY".

      ******************************************************************
       MISCELLANEOUS-ROUTINES SECTION.
      ******************************************************************
       COPY "LIBGB/GETPR.CPY".
       COPY "LIBGB/RMFILE.CPY".
       COPY "LIBGB/ACCESS.CPY".
       COPY "LIBGB/DACCESS.CPY".
       COPY "LIBGB/MKTEMP.CPY".
       COPY "LIBGB/SYSTEM.CPY".
       COPY "LIBGB/GETENV.CPY".
       SET-BRANCH-HEADINGS.
            MOVE BR-NO TO H-BRANCH.
            MOVE BR-NAME TO H-BRDESC.
       GET-SPR.
           MOVE LN-ORGST    TO SP-ORGST.
           MOVE LN-SPRCLASS TO SP-SPRCLASS.
           MOVE LN-SUBCLASS TO SP-SUBCLASS.
           MOVE LN-LAWCODE  TO SP-LAWCODE.
           PERFORM READ-SP1-FILE.
           MOVE SP1-KEY TO HOLD-SP1-KEY.
       TEST-STAT.
           IF STAT NOT = "00"
              PERFORM FORM-IT
              GO TO IO-ERROR.
       CLEAR-LEGEND.
           MOVE " " TO MESS.
           PERFORM SEND-LEGEND.
       SEND-LEGEND.
           IF ( EXT-ROUTE-BUF = "00" )
              MOVE "S  A000MSEL." TO VDU
              MOVE MESS TO VDUBUF
              PERFORM SCREENIO.
       CALC-HOLD-LN-ACCERN.
           MOVE LN-EARN-ORDER(1) TO SUB.
           IF SUB > 3
              COMPUTE HOLD-LN-ACCERN(1) = LN-ACCERN(1) +
                                          LXE-EARN(SUB - 3)
           ELSE
             COMPUTE HOLD-LN-ACCERN(1) = LN-ACCERN(1) + LP-EARNED(SUB).

           MOVE LN-EARN-ORDER(2) TO SUB.
           IF SUB > 3
              COMPUTE HOLD-LN-ACCERN(2) = LN-ACCERN(2) +
                                          LXE-EARN(SUB - 3)
           ELSE
             COMPUTE HOLD-LN-ACCERN(2) = LN-ACCERN(2) + LP-EARNED(SUB).

           MOVE LN-EARN-ORDER(3) TO SUB.
           IF SUB > 3
              COMPUTE HOLD-LN-ACCERN(3) = LN-ACCERN(3) +
                                          LXE-EARN(SUB - 3)
           ELSE
             COMPUTE HOLD-LN-ACCERN(3) = LN-ACCERN(3) + LP-EARNED(SUB).

           MOVE LN-EARN-ORDER(4) TO SUB.
           IF SUB > 3
              COMPUTE HOLD-LN-ACCERN(4) = LN-ACCERN(4) +
                                          LXE-EARN(SUB - 3)
           ELSE
             COMPUTE HOLD-LN-ACCERN(4) = LN-ACCERN(4) + LP-EARNED(SUB).

           MOVE LN-EARN-ORDER(5) TO SUB.
           IF SUB > 3
              COMPUTE HOLD-LN-ACCERN(5) = LN-ACCERN(5) +
                                          LXE-EARN(SUB - 3)
           ELSE
             COMPUTE HOLD-LN-ACCERN(5) = LN-ACCERN(5) + LP-EARNED(SUB).

           MOVE LN-EARN-ORDER(6) TO SUB.
           IF SUB > 3
              COMPUTE HOLD-LN-ACCERN(6) = LN-ACCERN(6) +
                                          LXE-EARN(SUB - 3)
           ELSE
             COMPUTE HOLD-LN-ACCERN(6) = LN-ACCERN(6) + LP-EARNED(SUB).

       READ-EARNINGS.
      * GET THE LXE-EARN'S FOR THIS REVERSAL
           PERFORM OPEN-LXE1-FILE.
           MOVE LP-BRNO   TO LXE-BRNO.
           MOVE LP-ACCTNO TO LXE-ACCTNO.
           MOVE LP-SEQNO  TO LXE-SEQNO.
           PERFORM READ-LXE1-FILE.
           PERFORM CLOSE-LXE1-FILE.
           IF IO-FG NOT = 0
              MOVE 0 TO LXE-EARN(1) LXE-EARN(2) LXE-EARN(3)
                        LXE-EARN(4) LXE-EARN(5) LXE-EARN(6)
                        LXE-EARN(7) LXE-WORKER LXE-WORKER2.
           IF REV-REBATE NOT = "Y"
              MOVE LXE-REC TO WK-LXE-REC.


      ******************************************************************
       IO-ROUTINES SECTION.
      ******************************************************************
       COPY "LIBGB/CONNECT_SQL.CPY".
       COPY "LIBLP/LPSPGS_SQL.CPY".
       COPY "LIBLP/LPLXGGS_SQL.CPY".
       COPY "LIBLP/LPLXEGS_SQL.CPY".
       COPY "LIBLP/LPLTPGS_SQL.CPY".
       COPY "LIBLP/LPLTIGS_SQL.CPY".
       COPY "LIBLP/LPLPGS_SQL.CPY".
       COPY "LIBLP/LPLNGS_SQL.CPY".
       COPY "LIBLP/LPCDGS_SQL.CPY".
       COPY "LIBLP/LPBWGS_SQL.CPY".
       COPY "LIBGL/GLGIGS_SQL.CPY".
       COPY "LIBGB/GBRCGS_SQL.CPY".
       COPY "LIBGB/GBBRGS_SQL.CPY".
       COPY "LIBGB/GBGBGS_SQL.CPY".
       COPY "LIBGB/GBPRINT.CPY".
       OPEN-PR-FILE-EXTEND.
           PERFORM OPEN-IT.
           MOVE PRU-FILE TO E-FILE.
           OPEN EXTEND PR-FILE.
           IF IO-FG = 8
              GO TO OPEN-PR-FILE.
           IF IO-FG = 7
              CLOSE PR-FILE
              GO TO OPEN-PR-FILE.
           PERFORM PRU-PREP.

       COPY "LIBGB/GBBRRN.CPY".
       COPY "LIBGB/GBGBRN.CPY".
       COPY "LIBLP/LPEDPATHIO.CPY".
       COPY "LIBLP/LPSP1RN.CPY".
       COPY "LIBLP/LPBW1RN.CPY".
       COPY "LIBGL/GLGI1RN.CPY".
       COPY "LIBLP/LPCD1RN.CPY".
       COPY "LIBLP/LPLN1RN.CPY".
       COPY "LIBLP/LPLTI1RN.CPY".
       COPY "LIBLP/LPLTP1RN.CPY".
       COPY "LIBLP/LPLP1RN.CPY".
       COPY "LIBLP/LPLXE1RN.CPY".
       COPY "LIBLP/LPLXG1RN.CPY".
       COPY "LIBLP/LPWKI.CPY".
       COPY "LIBLP/LPBP1IN.CPY".
       COPY "LIBGB/GBRC2RN.CPY".
       COPY "LIBLP/LPOPIN.CPY".

       COPY "LIBGB/FERRORS.CPY".
           MOVE "E" TO ERRCD.

       END-PROGRAM.
           PERFORM CLOSE-FILES.

           MOVE TEMP-PATH TO ACCESS-BUF.
           PERFORM REMOVE-WORKFILE.

      * RESTORE USERS ENVIRONMENT BACK TO WHAT IT WAS WHEN HE/SHE
      * STARTED THE BATCH PROCEDURE.

           MOVE HOLD-EXT-FILPATH      TO EXT-FILPATH.
           SET ENVIRONMENT "FIL"      TO EXT-FILPATH-FIL.
           MOVE ORIG-POSTNAME         TO WORK-USERID.
           SET ENVIRONMENT "POSTNAME" TO WORK-USERID.
           MOVE EXT-FILPATH-BRANCH    TO BRANCH.

           MOVE SAVE-BP-WK-REFCD TO BATCH-REFCD.

       EXIT-PROG.
       STOP-RUN.
           DISPLAY SPACES LINE 0 COL 0 ERASE SCREEN.
           DESTROY LONPW9-SCREEN.
           EXIT PROGRAM.
